 Hello, welcome to this video. We're going to be talking about self-hosting SvelteKit with a virtual private server, Docker, CapRover and GitHub Actions. My name is Stanislav. Let's get into it. So first of all, why would you do self-hosting? There are several reasons. One of those is privacy and data sovereignty. so when you use cloud platforms you're not never quite sure where that your data might be ending up and if you self-host then you do it on your own server which you can put in a specific region of the world and be sure that your data doesn't go anywhere other than that place another reason is that you're less reliant on third-party tools. So once you've started self-hosting and you're self-hosting your application, the next step is self-hosting your analytics, your observability, even your CMS. So that opens the door for those type of things. Another reason is portability. So when you use a cloud platform, then you might be using their database, their key key value store some specific functions like imagery sizing that they provide and by building your application to be self-hosted from the ground up you can easily move it between different servers without worrying about any vendor specific things that you might be using another reason is to avoid the cold starts i think many people who use serverless platforms are familiar with this concept and the difference when you self-host is that you pay for a server and you pay it up front for a whole month and then you have access to that performance so even if your app hasn't been used for you know for hours or even days once a request comes in it's going to be answered right away. So you're not gonna be paying any cold start penalty. So the last reason why you might want to self-host is because of cost control. So when you're using cloud platforms, you're usually paying on metrics that can be kind of obtuse and hard to calculate. Maybe you paying by gigabyte hour or something along those lines But with a virtual private server you know that you going to be paying for example a month and then you know that that's what you're going to be paying. No more, no less. But of course, self-hosting also has some drawbacks. So when you self-host, you have a single point of failure, which means that if your server crashes, your application stops working. I think this is less of a big deal than it was back in the day. So nowadays, if you use modern web technologies like Service Worker, then you can make it so that your app can gracefully handle being down for a little bit. And this is good anyway, because you might have clients that are on unreliable connections. For example, people might be on the subway, and that would have the same effect as your app being down if they lose connection. Another drawback is responsibility for maintenance and upgrades. So on a cloud platform, they typically, for example, update the Node.js runtime and when you self-host, that responsibility falls on you. And the last drawback is time investment. So, you know, it's very easy to download like a cool CLI tool and just be up and running in a few minutes with a few commands. But if you want to self-host, it's going to take a little bit of time investment, but you're going to be able to reap the benefits of that for months and months and years to come. All right. So why would we specifically want to use Docker and CapRover for this? well we developers we are familiar with the CLI tools and we don't mind them but sometimes it's quite nice to have just a nice admin panel that you can go into and see the status of your apps see logs, add environment variables, those types of things and CapRover provides that and why we use Docker for all this is because Docker lets us containerize apps so that means that each of your apps is packaged in a container and it works independently of all the other apps and it also is protected so that even if something were to happen inside the container it wouldn't be able to access other apps running on the same machine. Another great feature of CapRover is one-click apps and if you use something like cPanel you going to know what this is about So they have a catalog of hundreds of different apps And with just a few clicks you can install Redis or Postgres or MySQL or any number of applications, including more complex ones like WordPress. CapRover also has continuous integration support. And we're going to show that in the demo, how we will connect it to GitHub CI, GitHub Actions. to have a full CI flow. Another great feature of CapRover is automatic SSL certificates. So it's going to use Let's Encrypt, and you're going to get free SSL for all of your apps. CapRover is also free and open source, so it's actually written in TypeScript, so you can even contribute to it if you'd like. and the last reason is that CapRover can actually build the images for you instead of using GitHub CI so even if you don't want to use GitHub CI you can also use this stack without any other tools and so why would we use GitHub? GitHub is the most popular code hosting platform right now and they have a very generous free tier for public repositories when it comes to GitHub Actions and the lock-in that you can experience is pretty limited. If you really want to, you can still build your images on CapRover, but you would still need somewhere to put your code and even though you can self-host even that part with something like GTA or GOGS, it's way outside the scope of this tutorial. All right, so before we start, let's look a little bit of a high-level overview of what CapRover actually does on your server. So you have this box here, which represents your virtual private server. And CapRover essentially functions inside of Docker. So you're going to have your Docker inside your virtual private server. And CapRover is going to spin up some images for you once you install it. So one of those images is NGINX. And that will be used to route all the different applications you install, as well as route the CapRover admin panel. and this runs as a docker image. Then Caprover also sets up a docker image for its admin panel as well as a cert bot for automatic certificate management and a few other images to make everything work So that's kind of the CapRover part, which I've denoted here by putting little CapRover logos on the images. But that's just one of the parts, right? So the second part is your applications. And those also run inside Docker. each of your apps is going to run as a Docker container. So you can have as many apps as you want, as many as can fit on the server, giving the CPU and the memory constraints that the server has. And you can also run databases and really any other images that you want in here. All right, so let's do a little checklist. What do we need to install CapRover? So we're going to need a domain, and it doesn't have to be the full domain. If you already have a domain that you use for something, you can use a subdomain of that, and I'm going to explain how that works. You need a virtual private server to install CapRover on, and you need SSH access to that server. And then you need a GitHub account. So the steps that we're going to do, we're going to create a brand new virtual private server. I'm going to use DigitalOcean for this but you can use any server host that you want we're going to point a domain to our server install CapRover and then we're going to create a brand new SvelteKit project publish it to GitHub we're going to set up GitHub continuous integration through GitHub Actions and deploy the whole thing and then just at the end I'm going to demonstrate how you can easily add a database to your project Alright, it's time for the demo. Alright, now I'm in the DigitalOcean control panel and I'm going to go ahead and create a new server that I'm going to use together with CapRover. To do that I go to create and then I choose a droplet which is what DigitalOcean calls a virtual private server. And here I get to pick the region and you should pick something that is close to your users basically so that the latency is as low as possible. So I'm going to pick Frankfurt and then I get to choose the operating system and for this I recommend that you use the latest

 Ubuntu LTS version, the long-term stable version, because that's going to get support for the longest time. And then here I select which type of server I want. So what you're going to need, the cheapest server, usually has, on most platforms, usually has about half a gig of RAM. If you're going to be running maybe just one app, I think that is fine, but you're going to want to be running multiple apps on your server, I would recommend the Spring for 1 gigabyte. And that's what I'm going to do here. Then, we're going to choose which authentication method we want to use. And in this case, I'm going to choose password. And I'm just going to make a very simple password here. There we go. And I'm gonna save this for use later. Alright, and then here they also have some extra options so you can add the metrics to your server, which is very good. You can add automatic backups which is very nice to have in case something goes wrong or your server crashes for some reason. And they also offer you a managed database which they charge 15 bucks for but we're gonna do it for free by launching a database on our server. So here you get to pick a name. I'm gonna just call my server CapRover. and then I press create. All right so as you can see the server is creating. It is going to take a little bit of time but soon we are going to have we're going to have our server and our IP address for the server as well. Alright so as you can see we have our server now it running and we got the IP address and I gonna right away go ahead and SSH into our server so I have a terminal here I gonna type SSH root at the server IP all right so there we go and it's gonna ask me for the password and I saved the password here so I'm gonna put that in and now I'm into the server so from here we just gonna go ahead and install Caprover so if we follow this this guide that Caprover has the getting started guide they can advise you to start with installing a docker first so we're gonna go ahead and do that and I'm gonna go to this page which explains how to install docker on Ubuntu so first it asks me to run this cleanup command and I'm gonna go ahead and do that to make sure we're not we don't have any old version of docker or anything like that that running. Great. Then it's going to ask us to set up the docker-specific apt repositories. So I'm just gonna paste these commands in and this is gonna install some prerequisites and then here I'm gonna be adding the apt package source for docker. So I'm just putting in one command at a time here. And then here I have the actual command that I think is going to install docker for us. No, not yet. Okay, one command done. Okay, so we added the new source and now we're updating it to make sure all the packages are fetched and now we're going to install docker right as you can see it takes a little bit of time but not not too long all Alright if you get the screen I think you can just say OK here Great it done And then they have this command where you can check if the installation went OK. And it's going to print just hello world. Let's see if it works. It says hello from Docker. Great. So now we have the prerequisite all done and we can continue to install in Caprover. So to do that we run a docker command because if you recall all of Caprover actually runs inside of docker. So I'm just going to take the command I'm going to paste it and now it's going to install a Caprover for us. All right, now the installation finished. So if we keep reading it says that we should go to HTTP, the IP of our server on port 3000. Let's go ahead and try that. So I'm going to go back here, get the IP. paste it in like this alright so now we have the login screen and let's say let's see what they say so you should use the default password captain42 and then I can change it later alright let's go ahead and login alright so it says you have successfully installed the caprover but you still need to assign a domain and finish the HTTPS setup alright and then it's telling us to do it through the terminal so let's go ahead and do that so I'm gonna cancel out of the server now I'm gonna run this actually on on my machine, so not on the server. So first I'm going to install the CapRover CLI. Alright and then I going to run this CapRover server setup Have you already started CapRover Yes. It's gonna ask for the IP address again. Let's give it that. Alright and then it's going to ask us for the root domain. So here is where you're going to need a domain. So I have a domain here that I'm going to use that is not in use right now. And I'm using Google domains here, but the settings should be more or less the same, regardless of which DNS hosting you use. so you go to the DNS settings and then here is where you need to add some records so there's two records you need to add one record is for the root domain that you want to use so in our case we're going to use all of this domain and it's going to be an A record and it's going to point to our server and then we're going to add another record for a wildcard so anything dot my domain and it's also going to be an a record and it's also going to point to our server and the reason for this is that just like on heroku apps are going to have an automatic domain which is going to be like your app name dot your domain dot com all right so this is all you need so i'm going to save this and it's here it's gonna take a little bit of time to propagate it so it might not work right away but we're gonna try it in just a second just want to explain how you would do it if you want to use a subdomain so in this case let's say you wanted to use not the root but you wanted something like caprover dot your domain so in this case it works exactly the same you would put the IP like this and then you would add the wildcard as well. So in this case if you don't want to use the full domain this is how you would do it. But in our case we're going to be using the full domain.

 Alright. So now we have everything we need since we did the pointers. I'm going to put in the name of my domain here and then I'm going to set a password. Again I'm just going make something up and save that. I'm gonna enter it again. Alright, I'm gonna enter a valid email address here. This is for Let's Encrypt so that they can notify you if domains are expiring or not working properly, if the certificates is about to expire and is not being renewed correctly. All right, and now CapRover is actually going to go out and figure out the SSL certificates that are needed to make the server work. And at this stage, if you didn't wait long enough with the DNS record you might get some sort of error but in this case it did seem to work okay. It's gonna suggest a machine name let's just continue there alright and now we're ready to use our brand new instance so I'm gonna copy the domain from here and paste it in here and now captain 42 is not gonna work anymore because we we changed the name where we saw we changed the password so I'm gonna put in the new password and now we're we're in so this is the admin panel and now we can continue by creating a SvelteKit app. So to start with that, let's go ahead and create an app Maybe we going to call it just SvelteKit and we going press create and now the app is gonna be created for us so it gonna spin up kind of like a just a simple container so we can see here that we got a automatic domain here so I'll keep the domain I picked for the installation and if I go to this page I just get like a welcome screen that tells me that my app is going to be here when I deploy it and then now is a great time to actually set up our app in VS Code so let's go ahead and do that so I'm gonna just follow the guide here from Celtkit on how to create a new app. Alright, and let's do the demo app just to have something to show. And I'm not gonna use not going to use TypeScript and I'm not going to add any of these other packages just to kind of keep it brief all right so I'm going to follow the guides here I'm gonna install the packages Let's see, I need to use the correct version of Node. I'm gonna use Node 18 here. Let's try it again. okay and then just following the commands here that are given to me and then I'm gonna go ahead and open this in VS Code Alright, now we're ready to continue and the first thing that we need to do is to actually pack our SvelteKit app in a Docker container. So first of all let make sure that it runs correctly Alright so that seems to work okay So how do we pack this in a Docker container so we can run it in Caprover? So writing containers from scratch takes a while, so I have a finished container here, container configuration, that we're just gonna copy in, but we can briefly mention some of the things that go on here so so basically we are starting with a node image no 19 and then we basically run npm install and npm build just like so it's like kind of normal stuff and the one thing we need to do to make this work is we also need to switch to adapter node instead of adapter auto. So I'm going to go ahead and do that. Install it and I'm not sure if this is actually required, but I'm going to set also the build folder to write to build so that now when we run npm run build it's gonna create a build folder here for us yeah so there it is and what I'm also gonna do is I'm gonna add that to get ignore I looks like it's already added there great so now we have the the docker file that's gonna package the app and then we need to create a github actions workflow for it and you do that by creating a folder called github workflows so it's two folders first dot github then workflows and then inside here you create the yaml file and again building a workflow from scratch it takes a little bit of time so So I have prepared one here that I'm going to share with you. And what this workflow will do is basically, it's going to build the image, it's going to publish it to the GitHub Container Registry and then it going to deploy it on CapRover So let first let start with some things that we need to configure here specifically the deploy on CapRover part So it asking us for our server, which we have that, that's our domain. It's asking us for the app name. it's asking us for this token what is this token? I will show you so if you go back to the app in CapRover and you go to the deployment tab and you scroll down there is this official CLI deploy method and to use it we need to use this app token we need to generate an app token there we go so this token is what's going to let us actually deploy and if we look at the configuration it's coming from secrets and secrets is something that you configure on your app so in github so let's go ahead and and then publish this repository to github and then configure the secret so I'm gonna go ahead and publish this just to a public repository all right and I should be able to see that if I go here yes this is the package that I just published, sorry, this project that I just published. And then now I can go to settings for this project, secrets, which you can find here, actions. And then I'm going to add a new secret. And if we look what the name of that secret is supposed to be, it's app underscore token. and the actual value is going to be the value here that we got from CapRover. All right, so now it's configured and we're going to be able to access it here. Then it's asking

 Yes, which image to deploy and that's going to be this GHCR slash your username slash the name of the repository. All right, there we go. So I have some file changes here. So this is specifically the changes we've been making. I'm going to go ahead and stage those changes. and uncommit them and while we're waiting for that we're gonna go back here actually and there is one setting here that we need to change and that is this container port so when you build with adapter node the default port is 3000 and we have to set that here for it to work properly. All right. So let's go to our project here in GitHub and let's see what happens. All right. And it doesn't look like our workflow ran. Let's see what the problem is. I think I know it's because the branch name here has to match the actual main branch that you use. So let's try that again. All right, let's see again if something happens. All right, and there is one more setting that we need to do in the repository, and that is if you go under settings here, and then you go to actions, then at the very bottom here where it says workflow permissions, you need to change it to read and write permissions, otherwise your build will fail because it won't have access to push the actual image that was built. So I gonna just go ahead and add a tiny change here so that we can rerun the job All right, and now it's running. So, again, that's going to build the image on GitHub using GitHub Actions. It's going to push it to the GitHub Container Registry, and then it's going to send a ping to our CapRover server that the image has been built and that it's time to deploy it and CapRover is gonna deploy the image for us. All right and now our build has finished let's go back to the CapRover admin panel and have a look. So if we go to the deployment tab we can see here that our image has been deployed. This was an earlier deployment I did that I had some issues with, but here we can see that the image was deployed from the GitHub container repo. And you can also see the logs here. So it says listening. And then if we go back here and we go to the URL here, then hopefully we're going to see the demo app. Yeah, and here it is. And it's maybe a little bit hard to see because it's so small, but it is running on our domain, Celtkit.the domain name we chose. And if I want to add SSL to our app now, it's very simple. All I need to do is press this Enable HTTPS button, and it's going to create a new certificate for us. That takes a couple of seconds because it has to contact Let's Encrypt. And then I can also pick Force HTTPS here. So when I do that, I'm going to reload. And we can see that the connection is secure, certificate is valid, and we have our application running self-hosted on our cloud server. And the best thing about this is when you make a change, it's going to automatically redeploy. and you're gonna see your changes live when you push to to your main branch alright I also promised you to add a little database to there to this project so let go ahead and do that So I going to go to apps and instead of creating a new app here I going to go to one-click apps and this is the repo I mentioned where you can deploy images very easily that are already pre-configured. I'm gonna use the Postgres image so I'm gonna press Postgres I'm gonna call it just the DB database I can pick the version of Postgres I want it's gonna suggest automatically a password for me that I'm gonna gonna save here and a default database all right that's it I'm not gonna change anything I'm just press deploy. Alright and my database is up and running and I even got the example of how to connect to it from Node.js but what I'm interested in is this this domain here this is an internal domain it's gonna allow my SvelteKit app to access Postgres. So now we have two apps we have our SvelteKit and we have our database and in order to actually connect them I'm gonna use this a little database class so I'm gonna create a lib server folder and I'm gonna create a this database class side of it realize now that I don't have access to to TypeScript because I didn't choose it so let's go ahead and clean this out a little bit. Alright, and I'm gonna go ahead and create a API endpoint just to demonstrate the connection. So I'm gonna make a folder in routes called API and then I'm gonna create a server file here and I'm gonna clear out everything inside here and here's where I gonna do my query them so result go didn't really help me with the path there so it's helped a little bit go and down them Yeah, great suggestion actually from Copilot here to just get a random number and then return that number. Actually we're just gonna go ahead and return JSON from here. Yes, I think we do need to add this as well to get the first row. Alright, and then let's have a look at how this system works. So this database class expects an environment variable called db URL. So this is something that we're gonna have to add into our app for it to actually connect to the database. So let's go ahead and do that. So we're gonna go back into the SouthKit app. We're gonna go this time to app config, environment variables, add a key value pair and add this environment variable called dburl and we're going to paste the default value and here is where we're going to have to add the credentials from our database so first is the username and password and if i go to the database it has some environment variables as well so it has this postgres user so that one is just called Postgres. It has the password which I'm going to enter here. Then we have the actual domain of the database which is this one here. The port stays the same and the name of the database is also Postgres. Here we go. Save that and for now that's not going to do anything because we haven't deployed the changes yet.

 but if I were to stage these changes, there we go, and I'm gonna commit them. Since we already set up the deploy flow, it's gonna deploy automatically and then in just a little bit we will hopefully see the result. Alright, I had some errors when I tried to deploy that and the problem was that I put the lib folder on the wrong level, so I've moved that now. And also I need to install the Postgres package, of course. Alright, now the new version has been deployed. So let's see if we go then to the production domain, and we type slash API, which is where we put our endpoint. Then we can see that we get a random value back. And so this isn't just a random value with Matpunk random or something. This is actually coming from the Postgres server, so we know that the connection is working. Alright, and that concludes the demo So I have just one slide left and that is kind of where do you go from here if you became interested in this stuff Just some tips from me You can self-host different analytics providers like Umami or Phantom. You can self-host an observability platform such as GlitchTip, which actually uses the Sentry SDK. So you can use the Sentry.js integrations, but still have your own admin panel that you control yourself. You can do clustering. So CapRover supports clustering with Docker Swarm, which means that you can put your applications on multiple machines. there's a great image for local Postgres backups that you can run in Docker to kind of have continuous backup every hour or even every like 10 minutes of your production applications and then I encourage you to look into centralized log management because even though you can go to the app in the admin panel and look at the logs maybe you want to look further back in time and for that I found this app called Dozzle, which is also a Docker container, of course, that you deploy and then you have a beautiful UI where you can see all of your logs. So thanks for sticking with me and I hope everything goes well on your self-hosted journey.