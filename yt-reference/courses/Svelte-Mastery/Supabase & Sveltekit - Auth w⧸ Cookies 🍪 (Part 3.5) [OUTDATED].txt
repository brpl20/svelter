 So in this video, we are going to look at how to put the session in a cookie with SvelteKit and Superbase. And that way, when the user comes to our page, we can check if they're logged in or not, if they have a session, and then redirect them based on if they're logged in or not. So in the last video, we basically did it on the client side, but that's not ideal because the user comes to our page, they see something, but then we quickly redirect them based on whether they're logged in or not. But this does it on the server side, so it's much nicer. And full disclaimer, I'm not a cookie expert or anything. I just had to sort of learn about this over the last few days, like set cookies. So please leave in the comments if you know a better way to do this. I also looked at this article here and this article as well. But if you know a better way, if I'm doing something terribly wrong, please let me know in the comments. And please check the comments in case I did do something bad. But this is from my understanding. This is how you do it. And let's get started. So here I just have an app. It's pretty simple. Welcome to my app. This is a signup page, so I can put in an email like this and then sign up. And then this brings me into this page. And now auth will automatically redirect me to index. Redirect does also open is open for anyone. And then if I log out, now auth and open are okay, but index is locked. And redirect, well, it's always locked. It just redirects us to auth or index. Okay, so let me show you the code behind this. I'm not going to be doing any coding because it seems like the dev server is kind of a little janky right now. So I basically just built the project and I'm doing npm run preview. So let's have a look at the code to see how this works. Oh, and I wanted to show you also, let me just real quick. You can see here I'm setting the cookie here in the application tab under cookies. You can see here there's a session. I'm just storing the email, but this is everything that Supabase gives you back in the session after you log someone in or sign them up. But I'm just storing the email for now. I mean, it might be fine to store all this. I'm not exactly sure, but email should be okay. So let me come back here, and you'll see it's HTTP, secure, strict, same site policy, all that. And then when I log out, it gets removed. Okay, so let's go back to the code. So let's start off in our auth page. So we just have two forms here. And basically what I'm doing is sign up, we fetch the sign up endpoint, we hit that with post, and we put in the form data there. And you can just do form data if you have your inputs named. If they have a name here like this, name email, name password, then they can just go in as form data, like this, into the body. And then we'll capture that here in sign up, like this. So it got posted the request we can do request so whatever was typed into email and then request password whatever was typed into password and then with those we hit superbase and from there we'll get a session or an error so if there's an error we're going to just return that error back and you'll see here in sign up they're basically the same sign up and sign in if response.ok then we change window location to slash now goto wasn't working to with the goto wasn't working for me. I don't know if it's broken right now in SvelteKit or if it has to do with the whole session cookie. And goto is client-side router, I believe, whereas this is maybe hitting the server again. I'm not exactly sure. So you can do it like this. Another thing you can do is have this sign in, sign up. Rather than just returning status 200 with this set cookie header, you could also send like a status like a redirect status but I'll show you that later with the logout but for now we're just doing a sort of normal HTTP call like and then we come back with this header so this is how you set the cookie so set cookie session equals session dot user dot email and the question mark is just so we don't fail out maybe it's not the best to do that let's just say session dot user dot email so we put the email in the session path is slash so just anything here on our local host HTTP only that means you cannot access it from JavaScript so if I say document.cookie for example the session cookie is not in there well okay here it is now but let's say I um if I logged in and then I do uh now it's not there okay, because the HTTP cookie. Okay, it's secure, so it has to be HTTPS, or local host, I think it's fine too. Same site strict, and then expires, you're going to do session.expiresAt times 1000, because, so a new date of this, because the expiresAt is in seconds, so we multiply it by 1000 to make it milliseconds, pass that into new date, and then convert it to this UTC string like that and that is what we'll see right where is it expires right here yeah okay so that's how you pass in the cookie I'll try to put this code up on good hub and sign in is just the exact same basically except with sign in and then And once we hit that, response.ok, window.location, we move it to index. So we redirect to index. So that's one way to do it. So then we're inside and we're in our app. And from here we do logout. And I implemented this in a bit different of a way So first though let see how we got the cookie So we set the cookie but now how do we get how do we actually get this session in our page So for example, how do we see this session down here? Where do we get that from? Basically it's getting pulled from the cookie and put down here. So that is in our layout here. So we just have this function here, load, and we get the session. Okay, so how do we get the session from here to here? Well, that is done through this hooks. And it's pretty simple. It's just get session. Hooks has, you can do get session or handle, I think is the other one. They had another one before, but I think they removed it. Well, yeah, they definitely did. Yeah, it's just handle and get session. So get session, we can take the request, we can look into the cookies, request.headers.cookie.session. Or if it's not there, then I just put null. And this you can npm install, just npm install cookie. Okay, so we've returned that from here. And this is the get session function. And basically, whatever is returned from here is what gets passed into this load function here at session. Okay, so we just pull out the cookie, and then return that, and then that gets passed into here. And now we have this cookie. So this is auth. Basically, what it's doing here in auth is redirecting. So if there's a session, then we want to redirect to the main page. Okay, that's what makes it so I can't go here. So I try to go there, but it just immediately redirects me there from the server. Okay, so status 302 is what I read. Here is the best for redirecting. But any 300 thing is a redirect. So it says 302 and then redirect to slash. And I did the same here in index. So if there's not a session, then we're going to redirect to slash off. And then here in redirect, basically what I do here is it just always redirects. So you should not see me. So it always redirects. If there's a session, it redirects to the logged in page. If not, we go to auth. Okay, yeah. So that is how you get the cookie. And the steps are hooks, get session, pull it out here, and then you return it, and it gets passed into the load function. Okay. And then you can return from here and redirect if you like, but make sure you at least return an object from this load function. It can be empty if you don't need it, but you can return that or, um, yeah, status redirect or props, uh, like here. Okay. Finally, here, this last part is quite a bit in this video is the logout. So I implemented this a bit differently. Basically, so they're trying to encourage people to use forms without any JavaScript, if possible. And that's what we did with the logout button. So this would be another way. So rather than from the auth page rather than you know calling it with a fetch and then seeing if it okay and then like programmatically doing this we can do what they used to do oops yeah I'm going to index and just put a button inside this form and then basically we don't need this here is what I was doing before but we don't need any JavaScript. Yeah, we don't need any of that. And we just have this button, and once it's submitted, it'll go to logout route using the get method. Okay, so that'll hit this logout, and it'll just say, sign out. If there's an error, it's going to be returned back to me. And maybe I didn't think the error through very well about how to handle that. but you could show an error page or something instead. But let's assume it is successful. There's not many errors that could happen with sign out. But let's assume it's successful. Then it does a 302, which is a redirect, and the location that it redirects to is slash auth. And then we set the cookie, session is nothing, path, I don't know if, maybe that's muted, and then expires equals zero. So it immediately, or I guess it expires basically in 1970 when they first started this time. So basically the cookie will disappear. So this sets the cookie and then it redirects you to auth on logout. Okay, so then you don't have to handle it here in the, it's just a simple form, hit logout, and that'll take care of the rest. Though, yeah, if there's an error, I didn't quite think about that or handle that in this case. but you could, I'm sure you can figure something out. Okay. So that's a lot. Um, let me just quickly summarize with the cookie. So basically you have a sign in, you sign in with Supabase and then here, when you return, um, your returns in the headers, you put set cookie session equals session.user.email path, this, this, this, this expires here, 10 to 1000, blah, blah, blah. I'll put this in GitHub. And then in our, so that sets the cookie and then here in hooks, this is how we get the cookie. So this will give us a session then. We pull the cookie out and then we have access to it in our paths here in our load functions, which run on the server. Well, they run on the server and the client. And in this case, it's okay. But if only want them to run in the on the server if it's doing something else then you would import this browser thing from env right here and then you can check if it's on the server or not anyway but that's for a different video so yeah it passes into the session and then you can redirect using this here okay so that was a lot um this video was a lot longer than i was expecting let me know if if you have any questions, comments, and have a super wonderful day. Bye.