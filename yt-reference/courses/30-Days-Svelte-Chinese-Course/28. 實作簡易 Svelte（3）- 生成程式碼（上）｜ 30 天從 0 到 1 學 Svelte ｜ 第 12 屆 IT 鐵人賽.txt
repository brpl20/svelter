哈囉 大家好 我是凱凱歡迎收看凱凱寫詛事今天是IT天人賽的第28天了昨天我們已經把我們的解析器然後它可以解析Svelte的語法已經寫得差不多了然後接下來我們第一個要先試著把我們寫到現在的這個解析器把它變成一個JavaScript的程式然後呢接下來這幾天我們是會加入就是你可以在上面加入script的tag然後在裡頭可以寫JavaScript的程式碼那我們明天會開始實作這件事情那今天我們會先把這個layout的部分也就是我們可以從HTML然後把這個HTML轉換成相對應的JavaScript程式碼好那實作的部分的話呢因為時間上的關係還有複雜度的關係所以我們這邊只會實作element跟text那這個動態的text還有expression還有if block跟each block這些我們就先暫時不會實作這樣子好 那首先我們來看一下今天我們要實作的目標是什麼我們想要把這個左半邊的程式左半邊的html的語法變成右半邊的javascript的程式碼好那我們做到這一步之後我們就可以繼續做更多更進階的事情好那我們就馬上開始吧首先到我們的程式碼當中然後呢我們先看一下昨天的test好完全沒有問題接下來我們新增一個叫做 walk.js那 walk.js 當中呢我想要做的事情是我們要有一個方法可以去走訪整個 tree走訪整個正列走訪整個語法樹好,所以我們在這邊也新增一個新的 test叫做 walk.test.js然後在 walk 當中我想要做的事情是我們先定義一個 function 好了walk那它可以接收一個 ast一個語法術然後呢它可以接收兩個函數一個是 enter個是exit那enter就是說當我進入這個節點的時候我要做什麼然後exit的話就是我離開這個節點的時候我要做什麼好那首先我們先在裡頭做一些判斷式好了呃第一個我們先去判斷它有沒有children有些有些有些節點他並沒有chosen像text.node他沒有chosen還有動態生成的most.tag他也沒有chosenok 所以等於0的話呢我們就怎樣 就去呼叫這個function好然後再來elstiff ast.type等於text或者是ast.type等於mostktext的話呢我們就一樣做astok我們就去呼叫他再來就是一般的部分一般的部分是指什麼就是像element或者是text之類的嘛對不對好那我們稍微來看一下喔喔 目前只有element對首先呢我想要在我想要對每一個trojan去做走訪.forEach然後node然後在這邊我想要去遞回呼叫Enter我們進入了這個node當中然後呢我想要再做一件事情是我想要讓node有一個parent這樣我們可以比較方便的去等一下再寫程式碼的時候比較方便好然後我們去呼叫Enter然後進入了之後呢繼續去遞回呼叫 walk note然後呢然後再呼叫 exit node欸 等一下喔進入完之後要離開嘛對不對然後在最後這邊我們也去呼叫一個exit node 好這樣子應該沒問題好 沒關係我們先看一下我们先来写测试首先我们把我们的这个parse的function给录进来我们来写一下测试我们想要做的事情是我們想要做的事情是這個function可以就是它可以照順序來走比如說我今天的這個啊 等我一下喔假設我們今天想要做的事情是這樣子現在是直線,我把它變成彎這邊有DIV,然後底下有個SPAN然後DIV這樣子那根據這段程式,我們可以先猜測一下首先我們會有一個children,就是DIV然後進來之後,第一個會是SPAN然後span,我們把span的parent設成div然後enter nodeenter node就是進入這個span然後呢開始走訪裡面的東西然後所以我們會在第一回呼叫對不對然後現在這邊他的trojan是0因為我裡面沒有塞東西所以他就會呼叫一次exists然後呢再到這邊來喔不會,他不會到這邊來因為這邊就已經結束了好所以這個就結束了然後回到div這邊回到div這邊換div去呼叫exit然後呢我們最外層還是是一個fragment對不對然後最外層這邊再呼叫exit所以我在想這個exit或許也可以不用呼叫也沒關係沒關係我們先來看一下我們的結果是不是正確的好所以呢我們就去同時我們要把work把它引入進來所以我們這邊martial.exports work所以我們這邊也一樣work.require work好所以第一個我們先去parse我們先去爬內容div然後ears沒關係我們先全部都塞tag好了這樣子ok然後呢我會希望這個 walkastenter嗯想一下這邊要怎麼寫會比較好我們先放一個result好了然後呢每次enter我們就把所以我們就把node.type或者是node.name或者是...對,node.typenode.type加好了,node.name放進來然後exit這邊我們就先給一個空的function好,所以這邊我們先讓他跑一次跑完之後呢,我會希望我的result裡面呢會會有什麼?沒關係我們先看一下會有什麼我們預期他應該會是DIVSPAN喔?等一下喔他這邊說什麼?Invalid left-hand sign in assignment expression

這邊然後 cannot destruct不對啊exit of undefined or not這邊我們在遞回呼叫的時候也要記得把exit 跟 enter 也放進來接下來他說 node is not defined這邊要用 ast這樣子所以 div span看起來應該是沒問題沒關係我們再加入多一點東西ABCEFGTagsDIV然後進來Tags然後進來span好我們再加多一點結構好了來確認一下它是不是有照順序走這樣看是不是看得有點吃力我們把它變成比較好看的結構好了好,這樣子好,那我們來看一下div,然後進來text我們把text的內容也列出來好了這樣看得比較清楚加上node.datadiv,efg,span,txt,abc,ul,txt,li,li,txt,cd,cd,cd,cd感覺這樣子應該是沒有問題的好 所以Enter的部分是沒問題的然後我們就直接這樣子把它copy進來我想一下喔那現在我們就把這文字刪掉了因為文字的部分會有空白等一下喔我先讓我再把它變成比較難看的部分這樣子好那我們這樣子我這邊就簡單的寫等於element div 跟 element span好這樣子就OK了然後確認exit的部分它是不是有照順序跑出來那exit的部分的話我們來看一下程式嘛走訪完之後會跳出來然後最後再跳出來所以順序應該是走到div的時候然後再走到spam,然後spam沒東西嘛,所以spam跳出來然後再div跳出來所以這次我們就直接兩個調換就好然後我們把這個拿掉這樣比較好看總共有五個span,div,div,fragment所以感覺是有問題的因為你看喔span應該只要跑一次的才對所以我們來看一下我們來看一下程式碼邊有出問題這邊啊這邊因為我們是遞回的去呼叫他對不對所以這邊的exit照理來講這邊跟這邊都會在同樣跑一次所以我們只要留一個就好留一個的話要留誰留他留最外面的這樣子ok所以先叫span然後再叫div然後再叫fragment這樣應該感覺是沒有問題的好,那我們一樣用這種有點奇怪的方法不過沒關係,我們有保證它的順序是對的Fragment好所以我們已經確保了這個Enter跟Exit它們都有照順序跑我們再跑一個123好了看它會變怎樣123 對,text123會先跑出來好ok 所以我們知道了這個我們開放了enter跟exit這兩個函數之後我們就可以來做我們要的這個生成函數生成程式碼的部分所以我們這邊打一個generate.js好 那我們要做的format是長怎樣的我們要做的format長這樣子ok好所以我們一樣先把walk給引入進來然後parse也引入進來然後呢,我們寫一個generate函數generate 函數可以接收一個content首先我們會先去產生一個ast parse content再來我們會去work這個ast之後這邊就可以放node然後跟exit好那enter的部分呢我们想要做的事情是建立这些东西好所以我们可以这样写if node.type等于element的话呢我们这边就放一个字串好了let好所以这边可以加等于什么document那首先我可能我可能还想要放了一个是index那这个index是说我想要确保说因为你看我在这边会命名div跟spend1嘛那如果出现两个 的話可能會變成 div1 跟 div2所以我想要有一個 index 來做這個保存的動作這邊的話可以這樣寫parmap 等於 new map用 sets 就好了用set就好我想一下喔用set對 因為我們要辨別之後名稱而已那我們就把它放進來等於 document.createElement然後在這邊我們想要放的是是node.nametechnameDIVP這邊的名稱的話我們就讓它跟這個所以我們這邊可能要放一個index來保存這邊的話就要用map原因是因為我們要做對應的是Farm Map 跟名称对应到的index现在是1这边已经计数一次了可以这样写Farm Map.setString 放Node.nameindex的部分的話我們給01等一下喔等一下喔如果我們這邊可能要做的判斷比較複雜一點if farmap.has no.name的話呢代表說我們要去做一個index增加的動作嗯,不用

好 我們就讓它等於1就是我們就 這邊就幫它做加1set node.name然後format.get node.name加1等一下喔 我想一下這樣子好了好,然後如果沒有的話我們就把它設定一個初值,ok所以這邊的name的話我們就直接從node.name,然後這邊會有一個indexexitno.name這樣子好 然後exist的部分我們就一樣 if no.type等於element的話呢我們要做的事情是我们要做的事情是appendappend我们等一下会自己制作一个append的function那append这边我想要做的事情是这边是nodaNode.Name然後因為我想要去拿相對應的變數名稱所以這邊會變成Farmap.Gantt然後一樣Node.Name然後這邊我想要把它加入到Node.Parent.Name喔不對喔我們先判斷一下node.parent是不是存在然後如果存在的話呢我們就去拿node.parent.type.name嗯這邊node.這邊一樣我們要去拿farm map打欸?那這樣set我們是不是就不需要了對啊這樣set我們就不需要了不然其實對這樣set我們就不需要了好然後這邊farmap.getnode.parents.name這樣子這邊要有一個冒號帽号等一下乱掉了对啊,这边帽号等一下哦太长了嗯这样应该是没问题的然后这边再加一个啊这边的话我们就直接给一个fragment这样子好這樣寫不好對不對沒關係 我們來寫一次測試就知道我們先隨便寫一個測試generate等一下喔還沒有把它做輸出然後就打export generate好然後呢 generate什麼 等一下exportexportexportgenerate div p這邊我們要 return codereturn codeexpect code to be我們來看一下長什麼樣子Can I find module parts from generator.js?啊,index好,有了首先,這邊它這邊有寫對append p1到div1對,然後append div到undefined所以這邊有問題看一下喔這邊有問題ifnodaparent有在的話所以它走到這裡來這樣也不對啊,它應該會給fragment才對啊等下喔想一下喔所以node.parent.name等於 undefined然後這個也gap到所以也是 undefined所以它其實是這樣子啦if node.time等於fragment的話呢我們就讓它是fragment這樣子然後再這樣子看一下诶 还是on defineif no.apparent.type这样子有了有了有了这样子所以这样就对了嘛div1 then createok 所以這樣子一來我們就可以生成element 然後塞到洞裡面去好 那之後呢我們會把這些東西呢想辦法把它兜起來 變成一個可以重複使用的component然後再加上這個依賴追蹤啊 可以reactive更新的機制然後可能時間上是來不及做事件監禁器等等或者是生命週期的處理不過我想做到依賴最終的話應該可以讓大家比較理解這個svelte當中到底做了哪些事情好那這邊呢我們還有一件事情還沒有做就是我們只處理了element嘛對不對所以我們接下來要處理text的部分那text的部分也很簡單就是這邊我們寫一個else ifnode.type等於text然後我們這邊再加上一個好了or node.type等於text的話呢作法也跟哇,那這個可能要搬出去外面喔這樣子好好這邊也一樣加等於邏輯跟上面其實是一樣的所以我們就把它照抄不過這邊要改成create text node然後這邊要放datadata是text然後map.node.type然後這邊的話就叫t好了OK好 然後呢 如果我們還是分開來做好了

else if not.type等於一樣做同樣的事情不過這邊我就寫死好了就寫說不好意思現在還沒有實作,所以只能跟你上線然後這邊要加對,這邊要加引號把它包起來好這樣應該就沒問題了那現在生出來Code它的排版有點奇怪那這邊的話就我有讓它看得比較方便,所以就不要理它好,再來我們一樣再寫一次測試是general codeelementpure element然後這邊的話我們加個123看一下它長得怎麼樣嗯,有了,t undefined我們看一下喔No.typeNo.type好,所以這個text node也進來了放進來了但是這邊還沒有加進來所以我們這邊再寫一個哪邊這邊其實不用規定它是element也ok吧其實不用規定它是element也ok吧這樣子這樣子有可能會遇到好 所以不等於fragment的時候這樣子欸 還是沒有放進來等一下喔 我看一下在下面這裡看一下有沒有放進來這邊是 undefined所以這邊有問題node.name看一下喔哇 這樣好啦 我們還是分開寫好了啦等於 element 的話我們就這樣子生成然後如果node.type等於text的話我們就這邊複製過來然後這邊的話我們給t然後這邊的話給type那這邊的type一定是不一定這樣子好,這樣就沒問題了首先把T1塞到P1當中然後P1再塞到DIV1然後DIV1再塞到FragmentOK,感覺上順序是沒有問題的我們再多給一個P好了,345看一下哎呦,TNAN等一下為什麼會變成TNAN欸?好,沒關係,我們來看一下首先是 text 的部分出問題所以我們先看一下 text這邊也要寫Node type這樣就有T2了,然後P2然後這邊我想要讓它空行過來所以我們先看一下append的部分這樣子好,感覺整個程式碼是OK的好但我有点我们就直接偷懒吧to matchsnapshot好to matchsnapshotok好 這邊就產出來了看一下format上是沒問題了吧看一下喔看起來是沒問題 OK好 那我們就可以把這個code塞到塞到我們的程式碼裡頭所以我們再寫一個呃叫什麼compile好了compile.js他會做的事情是我們先去用filesystem然後一樣我們把generate呼叫進來好fs.writefile叫什麼叫做code.jscomponent好了第一個component然後呢data的部分的話就是generate欸不對喔不對不對我們要先read file所以我們等一下會做一個這個code等於ff read file sync然後我們會去讀一個das felt好 終於可以讀了然後我們把它放進來.toStringOK 這樣子應該就沒有問題了好 我們馬上來呼叫看看node.compile.js馬上有問題了我們還沒有component.spell所以我們先把它放進來然後 這邊divspamhello world再compile一次他說codebank must be a function等一下喔WriteBileSync好有了那我們來看一下Component.js喔 等一下等一下這邊是怎樣雖然說這樣寫應該是沒問題想一下有沒有問題好像有所以我們可能要把這個enter的字元跳脫成可以對 可以轉把它跳脫成這個%n的符號想一下這樣的話要怎麼做會比較好createx no這邊的話我們可能要這樣寫replace然後呢,partn變成這樣子對再試一次看看看一下generate的file嗯,這樣看起來比較好一些了,好一些了嗎等一下,append這邊的分號,分號都沒了欸好append下面的分号都没了这边再compile一次好这样子感觉又比较好一点了OK它现在是一个可以被format正确的JavaScript的程式嘛不过呢append的function还没有定义嘛对不对然后fragment但最後我們想要把它插入進來所以我們可以這樣寫

что doncdocument.appendbody.appendfragment然後這邊的話一樣先我們就直接寫s了我們就先訂一個append然後node targetOK 這樣應該就沒有問題了好 所以接下來我們就先再跑一次看看看會長什麼樣子好 它這邊有一個function進來了所以append的部分應該是沒有問題appendfragment還沒有定義所以我們在最前面再加入一個let fragment等於 document.createdocument fragment好OK這樣子我們就建立了一個相對應的JavaScript程式接下來我們建立一個index.htmlcomponentcomponent.html嗯然后明 我們就這樣子然後這邊我們把script引入進來component.js然後我們打開看看看看能不能真的跑起來還有一個小錯誤它說DIV is not defined我該不會忘記我忘記把這邊加上quotes因為它是個字串才對再跑一次喔然後檢查一次divok然後再重新整理有了喔太棒了我們成功了不過好對阿這樣子已經算是跨出了一大步了然後我們把結構變得再複雜一點看看component.svelte然後我們剛剛有它可以接收一個這個嗎不曉得能不能實作正確然後再來這邊隨便亂打ULLIITEM1ITEM2ITEM3好 我們跑一次compile有過打開哇 太好了竟然有正確顯示好等一下喔第二個spam是空的想一下為什麼所以這邊的這邊這邊我們忘記把它放進來了所以這邊可能再做一個處理想一下我看我已經忘記他的type長什麼樣子所以我們稍微看一下等一下喔,我們看一下Node我這邊是不是打錯了?打錯了打到這樣寫是對的嗎?到底哪邊是對的是這樣子我先確認一下單字是不是這樣寫嗯 對對對 沒錯這樣是對的好所以 這個拿掉然後我們再compile一次有 它又跑出來了然後這邊我們沒有給變數名稱所以我們給一下變數名稱變數名稱的話我們就直接想一下要叫什麼會比較好我們這邊就隨意的給吧而且 等一下喔我剛才發現我們都沒有等一下喔好沒關係這個 我們就明天再處理好了就先把它放著吧然後我剛發現我們都沒有用 let所以我們宣告一下變數名稱宣告一下別墅名稱append沒有問題好,OK然後再compile一次OK,然後一樣重新整理一次整理一次東西還是一樣順序也是一樣好,那我們今天呢就是這個HTML的語法透過我們自己寫的客製化的可以分析部分Svelte語法解析器之後呢我們再透過這個解析器生成的語法術把它變成一個JavaScript的程式再透過這個JavaScript我们要的这个结构然后之后呢我们会把这些东西把它包成一个spell component然后让它可以去第一个是有生可能没办法有生命周期不过我们想办法可以让它接受reactivereactive的assignment然后跟可以追踪值的变化并且及时的去做更新好那么以上呢就是今天的内容了我是凯凯我们下次再见咯拜拜拜拜