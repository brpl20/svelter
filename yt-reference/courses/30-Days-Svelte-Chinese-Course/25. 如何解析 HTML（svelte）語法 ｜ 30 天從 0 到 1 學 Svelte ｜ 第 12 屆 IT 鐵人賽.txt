Hello 大家好,我是凱凱欢迎收看凯凯写程式今天是IT天然赛的第25天了那么今天我们会来讲一些比较不一样但是还是跟Svelte有关的东西就是我们要如何解析HTML的语法或者是Svelte的语法那么在前面两天当中我们有提到Svelte它本身的生成程式码的流程是它会先帮你解析一遍你的程式码Svelte的原件然后它会生出CSS,HTML跟Instance这三个东西其中HTML的部分它是用Svelte本身自己写的解析器来做的为什么Svelte要做这件事情呢第一个大家可以看到左半边这边是一个正常的HTML的程式码的语言的标签的标记右半邊的部分是我們把它送給解析器過後它可能會生成出來的樣子你可以發現如果我們要用程式來解析或者是偵測這些資料的話其實它並不是那麼容易做處理的如果以左半部的HTML的語法來看那对于城市来说比较好处理的方式是我们把它变成一个object然后呢里头涵盖了这个tech跟这整个structure整个结构所应该有的资料啊跟架构啊等等所以右半边的部分呢对于城市来说它是一个比较好处理的架构但右半边的部分呢是对于人类来说比较好看的东西那为什么我们会做这一层转换主要是因为右半部虽然你可以一开始写程式或者是写你的这个Spelt原件的时候就直接用右半边这样的方法来写就是你就直接输入什么Type.fragment然后Trojan.但是你会发现当你的程式变得越来越多或者是你的HTML变得越来越长的时候右半部的部分其实它并不是那么容易一眼就看得懂至少对于人类来说那左半部的资料相对的是简短很多嘛然后我们看也看得很清楚這邊有一個H1 heading然後這邊有一個P然後裡面的資料是什麼裡面是一個text等等之類的那相對於右半邊來說你可能就要多寫很多東西然後可能也不是一眼就看得明白所以呢這就是我們為什麼要另外再解析H10的目的目的呢就是為了我們要把人類比較容易看得懂的語法轉換成城市比較容易看得懂比較容易處理的語法術AST好,那在SPHEL當中也做了這件事情那整個的流程的概覽大概是會有詞法分析,那詞法分析我們在這邊不會另外多提那詞法分析就是說一般來說我們會一個一個字元去解析這邊的詞法分析就是我會把每一個字元都轉換成一個詞法 一個token比如說 這邊的小魚這邊的小魚我會把它變成一個類似像是這樣子value等於小魚然後呢 type等於可能 open然後 tag 之類的這樣的表示方式那因為這邊的這個HTML語法相對還沒有那麼複雜所以我們這邊呢其實沒有另外做詞法分析的事我們是直接跳到語法分析那語法分析就是我們直接變我們從左半部變成右半部的這個過程我們把它叫做語法分析然後呢 語法分析完之後呢我們會生成一個抽象語法術也就是我們剛剛提到嘛 AST最後呢是生成程式碼所以呢 語法分析就是把這個像這種HTML語法呢 變成一個object或者是把它變成一個語法數element然後name等於div等等之類的然後呢這就是生成抽象語法數最後呢再把這個丟給程式然後它可能就會變成這個程式好,那這就是大概的流程介紹那麼問題來了我們要怎麼把HTML的語法轉換成語法術呢?我的意思是要怎麼透過程式把HTML的語法變成語法術這就是一個大問題所有的程式語言的解析其實它們都可以把它歸類成一個有限狀態機的應用什么意思呢有些状态其实就是在最刚开始会有一个初始的状态然后呢当你遇到某个资源我们把它叫做条件的时候呢你会开始进入到下一个状态另外一个状态然后呢在这个状态当中你可能做的事情是ABC你可以做的事情是ABC这样子然后呢可能遇到某个条件之后呢你又会跳到下一个状态然后在下一个状态当中你可以做的事情可能又不一樣或者是一樣等等然後呢全部處理完之後你可能會回到初始狀態或者是進入一個最終狀態等等那我們就把這種這個狀態的轉換把它叫做有限狀態機那舉例來說在HTML來說它也可以當作是一個有限狀態機的應用比如說我們在這邊我們以這個DIV當作范例好了当我遇到这个小于符号的时候呢我会进入到一个tag open的状态然后进入到tag open状态之后呢我会开始不断的去读取字元比如说D它是不是一个合法字元是I是不是V是不是它们都是嘛它们是一个有效的有效的字元好所以我这边就会有一个我們的程式就可以知道現在的tag name是div然後它有沒有attribute 沒有attribute所以我我們進入到下一個地方那這邊我們遇到了大於符號 所以我們會進入到這個等一下會講到 我們會進入到tag close的狀態然後呢我們再遇到了小於符號 所以又到這裡來囉 又到這邊來了然後呢又進入到tag open的狀態 然後我們遇到一個反斜線那遇到反斜线我们可能要进入一个tagend的状态之类的那这边没有写出来然后呢进入到tag end的状态之后我们又要去持续的读取资源读取读取读取读取了div嘛对不对然后呢这时候我们读取了大于符号那这时候我们又进入到tag close的状态然后呢回到初始状态等等好那在這邊你就可以去比較說比如說我們的open跟close的tag是不是有互相匹配比如說我如果今天這樣寫的話那這就是一個錯的可能是你寫錯了可能你忘記加了一個p然後這樣子之類的等等那在這邊你就可以抓到這件事情或者是說,下面有一個attribute所以有可能你今天的HTML長得像是這樣子data假設叫A好了,然後true好假設今天它長得像是這樣子等一下喔你今天到這個地方的時候到這個d他就會進入到這個attribute name的狀態然後呢不斷的讀取資源不斷的讀取資源然後讀取到這個之後呢當他遇到等於符號的時候他會跳出attribute name的狀態而進入到一個attribute value的狀態那這時候你這邊有這個double call對不對所以他就會讀取double call然後開始讀取這邊的value然后读取到下一个double close的时候大家说读取完毕了所以它的value就是true然后它又遇到一个大于符号所以它就进入到tag close stay然后它又遇到一个小于符号

进入到tagopen的stay然后呢遇到一个反斜线所以进入到tagend的stay然后再读取这些字元之后呢然后再读取到这个大语符号所以又回到了回到了什么回到了tagclose的stay好那整个呃程式的流程大概就会像这样子那我们可能明天或后天会开始真正的去实作一个简易版的这个解析器好那我们这边的范例大概就是刚刚那个样子就是我们有个div然后进入了tag open状态然后读取tag name然后读取好div之后我们读取到大于符号之后回到初始状态然后呢我们遇到了字源那一般的字源的话我们就是用text进入到text状态所以呢这边读取完之后Tags会变成Hello对不对然后呢这时候遇到了这个小语符号所以进入到TagOpen状态这边的反斜线应该可以叫TagEnd这样应该会比较清楚TagEnd然后呢在读取DIV之后呢把Tagnet设为DIV所以我们就可以比较说Close跟Open是不是有我們要把它們匹配在一起最後回到初始狀態因為我們遇到一個大於符號完成解析那假設說今天你在某個狀態然後這個狀態當中出現了你非預期的資源那代表有錯誤所以你就可以挑錯誤比如說今天我進入了這個我遇到小於符號所以我進入了什麼狀態我進入了tag open的狀態假設我下一個遇到的既然是一個大於符號也就是 tag close的話呢你就可以跳出警告說欸tag nameis empty 之類的所以呢透過這個狀態機的應用啊你可以很有效的去偵測說直接自圓現在在這個狀態是合法在這個狀態不合法的等等好那這個是解析之後我們可以產生的資料這個type等於element他是一個diff嘛對不對然後tag name等於,tag name是diff然後childrenchildren就是我們包在裡面的資料那他的type是text然後data等於hello好,那接下來我們看範例二范例二是一個有attribute的html這邊也是一樣,它也是一個狀態階的不斷轉換當我們遇到小禮符號的時候進入open然後讀取tag name然後讀取到一般的英文字元的時候進入attribute name狀態然後讀取完之後讀取完之後遇到等於遇到等於符號然後進入value狀態開始讀取value然後呢這個遇到double quote對不對那在HTML當中其實你可以這樣寫就是你可以省略double quote或者是你也可以用單引號或者是雙禮號所以要寫一個完整的這個HTML的解析器其實不是那麼簡單你要考慮到非常非常多的case而且在實際的應用當中你可能還會遇到比如說像這種common的node或者是什麼cdata之類的那這些東西你可能要另外考慮等等因為我們這邊就是我們就只考慮說最一般然後最正常的HTML所以我們這邊就不會另外再去說明好然後呢最後我們會就是再次遇到這個double quotes的時候會退出HTML的狀態那這時候我們就可以知道比如說 attrs 等於 rule然後 status 這樣子那你當然也可以加更多了對不對因為當你遇到這個時候遇到這個 quotedouble quote也就是退出的時候它會回到初始狀態也不是初始狀態因為它沒有遇到這個所以它會繼續回到 tag open 的狀態那在 tag open 的狀態當中你還可以繼續加 attribute 對不對比如說我今天這邊再加一個來一個 rule 等於 xxxaria xxx 等於 xxx假設你今天的標籤長這樣子那它遇到了這個又遇到了一個 a那它不是預期這個嘛所以它又會進入到 attribute name 的狀態裡頭然後繼續幫你做解析這樣子所以呢解析完之後這邊又會再加上一個 aria然後XXX等於XXX這樣子這個是解析之後產生的資料跟剛剛差不多只是這邊多了一個attribute這大概就是整個HTL的語法然後透過程式透過有線狀態機的轉換變成一個語法術的過程那麼剛剛講的都是一個就是只有一個HTML tag的例子但是事實上HTML是一個可以遞回或者是它的階層可以持續的往下延伸的一個標記語言比如說像是左邊的這個架構我們在dip裡頭又有兩個tag一個是p一個是ul然後在UL的裡頭當中又有LI然後你甚至在LI當中你可以再加入一個新的UL然後再加入LI等等所以呢HTML它的階層是可以一直往下漲對不對那在程式當中我們要怎麼處理這件事情呢最常使用的方式呢就是我們會去做一個遞回也就是我們會去遞回的去解析這個HTML的語法那最常见的这个解析器呢就叫做递回下降解析器那之后呢我们会透过实际的应用跟这个Keynes一下SPELLS的解析器的實作來解釋什麼是低迴下降解析器為什麼SPELLS我們本來就可以直接把HTML語法丟給瀏覽器然後讓瀏覽器自己去解析為什麼SPELLS才要做這件事情第一個,因為spilt畢竟是一個library所以你產生的HTML並不是一個真的HTML而是一個spilt在run開當中幫你加上去的HTML比如說在spilt當中是用document.createElement然後append child幫你把element塞到真正的動力通除非你是用SSR所以Svelte當然要知道整個HTML架構是怎麼寫的再來另外一個就是說Svelte因為它自己有它自己的語法比如說我們之前介紹的if block, bind, on等等Svelte有非常多這種自己另外再加上去的語法所以這些語法當然原生的HTML瀏覽器當然看不懂了對不對所以這個部分Svelte當然也要自己另外再做解析然後再來還有一點是因為解析之後我們可以或多或少我們可以透過這個語法術得知這個語法裡面的資訊比如說變數有沒有用到變數tag有沒有正確的關閉然後依賴追蹤有沒有宣告變數或者是做一些警告等等這些東西都可以讓都可以在我們解析一遍這個語法之後可以得知到這件事情所以這也是為什麼SPEL只要自己寫解析器的原因好那這邊只是很粗淺的講這個HTML的語法大概要怎麼解析不過其實這邊有蠻多省略的事情第一個就是HTML它可以支援一些沒有close的標籤那这个是什么意思呢?比如说你今天写了一个ul然后你今天偷懒或者是

你忘記寫了XXXXXLIXXXXX然後再一個LI這個是一個合法的HTML也就是說HTML會自己幫你也不是自己幫你啊就是他會知道說喔你其實是想要關起來的就是他會幫你分成這三段也就是說你實際上呢可以看到他正確的顯示像是這樣子那這件事情當然就是要另外的去做解析了所以我們之後在實作的時候會忽略這種假設就是全部的標籤都會好好給它關起來然後還有像是我們剛剛有提到Cdata跟Common的處理我們也沒有提我們也沒有額外的去做好那HTML它本身是可以支援大小寫的比如說你可以這樣寫好那這個就是在解析的時候你可能也要特別注意一下好那我們可以看一下這個spelled不是spelled我們可以看一下HTML本身的它的規範有怎麼寫這邊有一個長長的規範寫說一個標準的HTML應該要怎麼樣去做解析那在這邊它列出了很多這個State看滿滿的喔 總共有80個State那可能大家比較有興趣的是這個Plain Tags跟TagOpenAnd TagOpen跟TagNameState還有這邊的Attribute相关的stay那剩下的部分的话就是这个比较额外的东西啊跟还有像script啊等等tag之类的东西那这边的话我们就不另外多讲然后呢它在这边会清楚的告诉你说比如说你进入到tag open stay之后啊你要做哪些事情然后遇到哪些符号的时候要做什么事情比如说你遇到ASCII Alpha的时候会到这个TechNamesDay然后然后你进入到TechNamesDay之后它又会告诉你说遇到Space要做什么事然后遇到遇到写信要做什么事遇到大于符号要做什么事等等好所以呢透过这个HTML的解析的文件呢然后再搭配你的程式你应该可以写出一个完整的HTML的解析器当然你要把全部的东西都实作出来并不是一件那么容易的事情不过呢我们在之后的章节呢会跟大家介绍说如何写一个简单够用就好的一个HTML的解析器然后呢再透过这个HTML的解析器呢搭配到我们自己手写的一个小型的svelte当中好那么以上呢就是我们今天的内容啦我是凯凯我们下次再见咯拜拜