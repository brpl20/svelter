哈囉大家好,我是凱凱,歡迎收看凱凱寫程式今天是IT天人賽的第24天了今天我們會延續昨天談到的sphilts如何編譯程式我們會再繼續講解這一部分我們昨天講到sphilts它會先把你的Sphilt原件編譯成CSS HTML跟Instance這三個語法術AST抽象語法術然後接下來Sphilt就會把這些語法術變成程式碼也就是編譯的動作好,那實際上它會怎麼編譯呢?首先我們可以看到左半邊的程式碼這邊我們在script裡面宣告了一個變數叫做name然後它的指示word所以在語法術當中會產生一個Decoration的語法術然後呢我們在html當中用一個ptag然後內容是hello然後我們塞了一個變數name在裡頭那在右半部呢是svelte編譯過後長的樣子所以這些程式碼不是我們自己要寫的喔是這個svelte會針對左半邊這邊的程式碼產生出來的那你可以看到這邊有一個Function叫做CreateFragment然後它可以接受的一個參數是ctx那我們這邊就先把它叫做Context好了然後呢在下面這邊你可以看到有一個Name等於World對不對那這就是我們剛剛在Screen裡面宣告的然後呢嗯再來Spell這邊會幫你宣告一個ClassAppExtendsSpelledComponent那這個SpelledComponent就是我們實際在Rontime的時候會用到的SpelledComponent好所以我們接下來會再深入的看一下CreateFragment的部分好那我們先跳到我們的程式碼當中首先你可以看到這邊是我編譯我們先把一些不必要的程式碼刪掉你可以看到這邊就是spelled產生出來的程式碼好那回到這裡首先呢我們來解釋一下fragment裡頭每一個函數的意思好了第一個是c那c的話是create-簡顯那就是建立element的意思這邊的像是Element、Text、Append、Insert都是原生的動API的包裝而已比如說Element就是DocumentCreateElement的封裝然後Text就是Document.CreateTextNode的封裝Append的話就是AppendChild的封裝然後Detach就是RemoveChild的封裝好,那是C的部分and的話呢是mount的部分也就是在我們umount的時候會做的事情svel在這邊做的事情就是幫你把這些在我們c函數裡頭建立的這個element全部都塞到真摺洞裡頭然後再來是pp的話我在這邊把它叫做patch或者是update都可以是元件更新的時候會執行的事情比如說我們在假設我們在這邊加上一個 setTimeout然後name的一開任好了你可以看到這邊的p就會有一個if30,然後and1然後去setData那這邊的1的意思啊其實是這個spell 裡頭用一個叫做Beat Mask 的技巧也就是說呢它會把這個所有變數的的值呢放在它會把dirty這個變數當成一個正列那假設呢不是當成正列啊當成一個數字那假設我的第0個數字好了是代表name是不是dirty然後呢假設第二個數字是假設我在宣告一個新的變數A等於Cadon好了是不是dirty所以呢我們在這邊要比較的話就可以很方便的去比較說欸假設我是第一個是name好的所以假設我的is我們假設把它叫做position等於0好了 那我就可以這樣比比如說這樣子就可以去比較說誒我的Nan現在是不是dirty的狀態好 那這樣用有什麼好處呢我的意思是說為什麼我們不直接這樣寫就好Nananddirty 假設好了Nan is dirty那這樣的好處是說我可以用一個變數也就是我可以用30一個變數呢來控制很多個flog假設我們現在有有10個變數好了那我就只要塞10個數字就好2 4 6 7 8 9 10然後呢我就可以用這個Bit Mask 的技巧來判斷哪一個變數是 dirty 的狀態好那比較詳細的介紹我會放在說明欄當中這邊所以在這邊它的意思就是說它會去比較 name這個東西是不是 dirty那 dirty 的意思是什麼呢Dirty 的意思就是說比如說我的變數已經有被改變過了比如說我在這邊過了一秒之後我的變數有被改變所以呢我要告訴spelt請幫我去觸發更新好那spelt在這邊做的事情是幫你去做setData的動作也就是說在這個階段當中呢spelt會做的事情是幫這個變數呢設定成新的變數那他把這個變數呢保存在context0的地方好那這就是update做的事情再來是I跟OI跟O分別代表Transition的intro跟outro的意思也就是當Transition要進場的時候會執行的函數跟要出場的時候會執行的函數那因為我們在這邊沒有用Transition的這個功能所以它這邊就是noop就是沒有做事情的意思我們今天如果加進來的話你看它這邊就會幫你加上這個東西什麼add render callback然後olderBooter也會幫你加上一些東西那我們這邊把它拿掉OK最後是d,detachdetach的話呢就是把元件銷毀了那圓件銷毀你看這邊是一個很簡單的就直接做一個detach 的話呢就是把元件銷毀那元件銷毀 你看這邊是一個很簡單的就直接做一個 detach那 detach 裡面的函數的十座就是remove child好所以呢 這就是 create fragment 在做的事情然後呢我們再來看一下下一個是一個 instancespellts呢 假設你在這邊都沒有寫程式的話spellts是不會出現instance的函數的它只會有createFragment而已好 那假設你在這邊還有其他的程式嘛比如說我這邊有加一個setTimeout對不對那這段程式嘛spellts就會把它放到instance當中看這邊就會有一個instance或者是我在這邊做一個 console log好了或者是我們用一個 relativity 的 assignment relativity 的功能的話它都會放到 instance 這個函數當中那麼 fields component 會在 runtime 的時候去決定說要什麼時候去呼叫這個函數這個函數,instance這個函數那它裡面傳來的這三個東西那比較重要的部分是在於第三個,invalidate任何你去重新複製或者是你做++++等於的動作呢都會被svelte用invalidate給包裝起來那麼invalidate裡頭會做什麼事情呢?它裡頭會去第一個它會幫你把這個變數標記成 dirty也就是說這個變數已經被改變了所以我應該要去更新它好,那到 dirty 之後就會到這邊嘛對不對這邊的 patch或者 update 就會知道說Name有被更動過所以我要去 set data好,然後呢既然去觸發觸發了這個invalidate所以呢,spell也會幫你去安排更新,然後去run,比如說beforeupdate或者是afterupdate等等之類的函數等等好那這就是instance裡面會做的事情再來我們再回到我們的程式好,再來呢是EventListenerEventListener的部分的話呢,假設我在這邊宣告一個unclicked函數的話它會在end裡頭呢放一個這個mounted那所謂的mounted就是有沒有被掛載上去然後如果還沒有被掛載的話呢我們就先加入一個EventListener進來那這邊的listen也是一樣它是一個addEventListener包裝這樣子然後mounted等於true所以呢,這個Listen就只會跑一次好,然後你會發現這邊有一個它還會幫你加上一個Dispulse那這邊的Dispulse呢就是這個Listen的函數呢,它會回傳一個Remove,就是相對應的RemoveEventListen的函數這樣子所以呢在detach,也就是原件要被銷毀的時候我們會去呼叫它然後呢它就會幫我們去銷毀對應的事件鑑定器好最後呢我們來看一下這個生成的svelte裡頭生成的svelte componentsvelte component這邊你可以發現這邊有個init那這邊的init也是svelteRuntime裡面的始作好那你看這邊的instance就是我們上面這邊的instance跟CreateFragment 就是上面的CreateFragment好 然後呢這個呢就是你實際在run time的時候會使用到的SpelledComponent 你看我們最後是ExportApp出來那App它就是一個SpelledComponent好 那裡面的實作也很就是比較複雜一些 我們在這邊只講一些大概SpelledComponent裡頭會有一些東西第一個是30 也就是我們剛剛提到的他會去判斷說哪一個變數現在是Dirty的狀態然後需要去做更新再來是CTX我們提到了剛剛比如說我們宣告的變數Nan或者是這邊的Calden都會把它保存在這個CTX當中Context當中再來呢是AfterUpdateF-update是一個Array嘛對不對所以假設你在spells進行AFTUpdate或者是BeforeUpdate的時候它實際上的實作就是它會幫你把你在BeforeUpdate裡面所宣告的函數呢放進去對應的spelled componentAfter update的陣列裡頭然後spells 會去知道說什麼時候應該要去呼叫他spells 會在正確的時間點呼叫那 props 就是 props我們從export let宣告的東西然後還有 fragmentFragment就是我們這邊的CreateFragment的部分然後BeforeUpdate就是BeforeUpdate然後Amount跟Undestroy他們一樣都是陣列你在呼叫Amount或者是Undestroy的時候他們就會幫你放到相對應的陣列當中那這個呢就是SpelltsComponent裡頭大概有的東西啦好,所以呢到今天我們學到了第一個,svelts會先幫你的svelts元件變成語法術css,html,instance然後呢,它會把這些語法術編譯成像這樣子的東西有createFragment跟instance還有app還有svelts component然後呢,createFragment裡面會做的事情就是就是它會宣告各個事情要做的事情Create要做的事情Mount的時候要做的事情Patch update的時候要做的事情然後intro跟ultro的時候要做的事情跟銷核元件的時候要做的事情再來是instance的部分instance的部分是你在script tag裡頭除了宣告變數或者是impro東西之外執行的程式碼都會被包在instance當中然後這兩個東西呢就會被送到這個spelled component init的參數裡頭好,那這就是建立一個spelled component的過程所以如果你知道這整個流程的話其實你也可以自己這樣寫啊,對不對你也可以自己寫一個但通常不是很建議這樣做啊因為這樣做的話你就要自己去寫這些函數好今天的內容就差不多到這邊結束啦明天我們會再繼續講解有關Explot內部的各種實作好的那麼我們就下次再見囉掰掰