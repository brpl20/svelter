哈囉大家好 我是凱凱歡迎收看凱凱寫程式今天是IT田人賽的第23天了今天我們終於要來講解一下Spellts的進階篇第一個就是Spellts是如何編譯的首先我們來看一下Spellts整體的編譯流程第一個Spellts裡頭有一個小小的parser當他遇到HTML語法的時候他會用這個svelts作者寫的parser去把HTML語法爬一遍第一個呢我們可以在他們svelts的HTML語法當中用大瓜糊來做表達式或者是直接放變數嘛 對不對那麼這裡頭的表達式本身因為它是JavaSquare的語法所以呢是用 Acorn我們等一下會講到它是一個JavaScript的這個Parser的韓式庫來解析然後遇到像是if、each、awaits還有像這種spell內建的一些樣板、模板的語法的話它就是會另外處理就是用作者本人寫的Parser最後會產生一個HTNL的語法術好,這邊做完之後再來是 CSS 的部分任何被包在 style tag 下面的程式碼或者是 CSS 語法,都會變成一個 CSS 的語法術所以它並不是直接把你的樣式就直接全部 copy paste 過去它會先用 CSS Tree 跑一遍之後它會去產生語法術這也是為什麼Svelts可以去感知到或者是偵測到說有哪一些class你是沒有用到的如果你是靜態宣告的話再來是在script裡頭也就是最上面script裡頭Svelts會使用acron來做一些分析那當然裡頭還是會有一些客製化的分析邏輯然後再產生相對的語法術好,那經過這三個流程之後,語法書就完成了然後完成之後呢,這個語法書裡頭會有三個東西一個是CSS,然後另外一個是HTNL,最後一個是Instance好,那我們就直接來看一下程式嘛如果你要使用Spellts的編譯的功能的話解析的功能的話,你可以到這個East Explorer這邊,然後呢,在這邊選html這邊,然後再選spells就可以幫你做編譯了,好或者是你也可以直接去使用spells內建的方法,這邊有一個parse那Parse回來它就會幫你編成一個語法數這樣子那你也可以從這邊去直接看它的output是什麼那我們這邊就直接用線上版的大家看得比較清楚一點好那我們先把它放大然後我先寫一個scriptConsoleLog你會發現svelte編譯完之後它會變成一個語法術然後放在instance的部分然後呢實際的程式就會放在content裡面這裡頭就是我們要的呃我們要的也不是我們要的就是acron產生的語法術這樣子好那你可以發現說這個是一個CoExpression嘛對不對那這個是Console 然後這個是Member這樣子所以他這邊就會幫你爬解析出你現在做的是什麼事情然後他就說這個是一個ExpressionStatement然後有一個CallExpression然後裡頭是MemberExpression好然後呢你也可以去宣告變成什麼對不對比如說A等於CALOR這樣子好那這邊他就會產生一個FariableDecoration好,那產生這個FariableDecoration之後呢因為現在我們就可以知道說你現在做了一個變數宣告的動作了對不對所以Sphilts就可以把它放到它的這個Lookup當中也就是說你在這邊訊號一個變數之後spells 會在 compile 的時候把這個變數放到他們的 lookup table 當中所以假設我在這邊用了A好了spells 會知道這件事情或者是你今天用 B 結果找不到因為既然我們是先預先編譯所以spells 可以先建一個變數的 lookup搜尋列表之後去看說有沒有比如說if b existOK 然後如果沒有的話呢如果沒有的話就是跳警告對不對NG 那他這邊的這個原理呢就是說我可以在這邊做到這邊這邊會有一個Fariable Decoration然後呢我們再去這邊去找說當我們看到這個Name等於B嘛對不對那我們就去看有沒有B這個變數我們就知道說到底是不是有使用所以你可以發現假設我在這邊打了一個B他會跟你說B is not defined那我如果沒有用Cons他還是會跟你說第一是那地方所以這就是這個語法術的強大之處他可以幫你在編譯的時候給你一些資訊然後讓你去做一些判斷那這件事情我們就不用再移到Runtime來做那當然這也有一個壞處啦那壞處是什麼呢假設今天我用沒有辦法我就是用Runtime的方式來做的話Svelts就沒辦法知道這件事情比如說假設今天我用了Evaluate這個函數然後我在這邊這樣寫Spells 其實他是不知道這件事的然後他就沒辦法幫你做優化也就是說當我在這邊做的時候比如說我今天我今天寫一個setTimeout然後一秒之後執行然後我裡面用Evaluate然後呢,我們直接打Name等於Karen好了你會發現,誒,過了一秒之後我這個東西沒有變化那這是因為呢Spells會先幫你編譯這一個變數的宣告變成這樣子因為我們這邊沒有做改動所以他這邊沒有幫我們編譯出來好,那我們這邊再設一個你看所以這個是有效,但是這個是沒有效的那這是因為呢,Spells會幫你的變數宣告呢給編譯成像這個樣子所以呢,我們實際上是在呼叫這個invalidate這個函數然後讓svelts去感知到說這個component現在要更新但是呢你會發現這樣做就不對了我們直接用evilite然後裡面塞的是自傳雖然我們可以在run time做執行但是結果就完全不對了但是相反的比如說你用react本身的話你是可以完全用react打create element來做事情那這就是這個svelts跟react人生的差異好那我們回到我們的Explorer出來現在呢你已經有了這個html然後instance也有了然後我們再看一下style假設我這邊打一個方...size...4px你會發現spell也會把它當作是一個語法術來對待而不是整個複製貼上然後你看這邊也是可以偵測到語法術什麼的所以有這個東西之後我就可以直接比如說跟這邊的這個class name做比對嘛比如說你就可以去比較說在這裡面的class name裡面是不是真的有A那如果有的話就幫我列出來這樣子不過這裡有一個壞處就是今天Spills他不會知道說假設假設你這邊class name給A好了然後這邊給一個A這樣子然後這個拿掉好了他會說onusecssselector對不對那假設我今天這邊給一個b然後a這樣子然後假設我這邊改成c好了d好了你看spells就不會再跳警告了對不對但實際上這個a他是沒有用到的也就是說spells他並沒有辦法動態的去知道說你現在用的class的名稱是什麼它只有當你是靜態的時候或者是空置串的時候才能給你建議這樣子好那做完這些東西就是產生了這個語法術之後啊Fields就會開始準備編譯那麼在編譯的過程當中他會做一些像是Accessibility的檢查比如說比如說他說unknownerarar.htributearar.model...什麼的model那我們如果把這個東西加到這裡的話我們看一下它會怎麼寫你會發現這邊有一個多了一個attributes所以你的spells就可以去檢查說我的語法術在Attributes這個欄位當中是不是有ARA開頭的東西那如果有的話呢幫我去檢查說這個ARA是不是合法的一個名稱那models不是嗎?是models才是正確的所以spells就可以在編譯的時候做出警告或者是ahrif等於nor噢,不能打寫NO我們給一個空字串好了給一個警號一樣啊,這個東西也是屬於attribute的一種所以假設我放到這裡來這邊有一個所以我們就可以去比對說這邊的value是不是一個合法的值那如果是的話就通過啊如如果不是的話就列出警告等等好 所以透過語法術你可以知道說诶 語法術可以在編譯時期帶給我們蠻多資訊的所以只要善用語法術我們就可以做到很多事情 然後再相對的可以減少在run time裡面要做的事好 然後再來還有像是變數的全告檢查跟選擇器檢查這我們剛剛有講過 還有依賴生成那所謂的依賴生成呢詳細的部分我們可能沒辦法講太深 或者是可能會移到其他的其他天來講但比如說在這邊我做了一件事是欸setTimeout然後A++好了那我們來看一下生成的語法是什麼這邊那我們的A++跑去哪Body啊那這邊有一個update expression嘛對不對所以呢spells就可以去偵測說如果發現了update expression那就幫我放到這個put me into d它就可以因為你去做了這個update expression的操作所以spells 就可以在編譯時幫你把它放進去dependency array那當這個值有變動的時候我們就可以做對應的更新這樣子或者是還有什麼加等於1好了加等於1那一樣,這就是一個assignment expression所以像是assignment expression,update expression還有什麼?還有直接複值的嗎?直接複值的話應該也會是assignment expression對,也是assignment expression所以可能實際的場景可能還有更多啊那我們這邊先假設說遇到了assignment expression就幫我放到dependency裡面或者是遇到了update expression就放到dependency裡面所以呢放到dependency的東西呢他們都會變包成這個被包成invalidate然後呢我們就可以去比較說哪些地方有變化然後如果這個只有變的話呢就幫我們去Trigger Update所以呢當你去呼叫這個Infaliad函數的時候呢Infaliad裡面的函數它在做的事情就是幫你標記這個變數或者是標記這個元件成Dirty的狀態然後呢當Spells發現這個這個變數是dirty的時候就會去setData然後setData之後就會去觸發更新這樣子好,那這就是整體Sphelts編譯跟生成程碼的流程然後我們明天會再講更多有關於Sphelts在公開時期做的事情有哪一些今天就是這個Spilt原理的講解今天的內容就到這邊結束啦我是凱凱,我們下次再見囉掰掰