哈囉大家好,我是凱凱歡迎收看凱凱學程式今天是IT鐵人賽的第12天了在前11天當中,我們花了11天的時間把Svelte幾乎啦,不敢說全部,幾乎大部分的功能都學完了所以從今天開始我們會介紹一連串關於Svelte在前端當中如何實作各種UI畫面今天我們要介紹的就是API的處理以及畫面的互動API的處理應該是前端當中最常遇到的場景就是我們去呼叫API當API沒有載入完成的時候我們先顯示loading畫面載入中畫面當API載入完成之後之後呢我們把資料顯示到畫面上那在這期間呢你要考慮幾件事情第一個是載入成功就是一般的情況下但有可能server掛掉了或者是其他的情形等等有時候你的API可能會失敗那如果失敗的話我們就要做錯誤處理好然後呢另外一個你可以考慮的是這個API應該要在原件裡頭呼叫或者是在其他的地方处理比如说你这个API的结果或者是状态可能会和其他元件共用的话那么你可以使用我们在之前有提到的StoreSvelte里头的Store来做处理或者是呢比较简单的API那你可以用我们之前提到的Await这个语法来做处理好所以呢我们今天会透过GitHub的API然后搭配Store来实作一个UI那这个UI的功能非常简单它就像这样子这边有三个按钮虽然看起来不太像按钮就是有这个灰色方块的这个然后呢比如说假设当我按下React的时候呢我会控制我的这个前端的程式码去呼叫GitHub的API去找有关于React的这个函式库然后当我点下Fill的时候呢就会去找fug相关的函式库然后点svelte的时候就会去找svelte相关的函式庫然後等資料載入完成之後就把這個UI顯示出來這個功能大概就是這樣首先我想要它第一次載入的時候是以re-add為預設值因為現在re-add比較熱門然後在API還沒有載入的時候我們在畫面上顯示loading的文字那或者呢如果你比较如果你想让画面更好看的话你也可以去设计比如说一些动画loading的动画或者是一个这个假的这个UI的界面来让你的loading的画面变得更好看也可以然后呢在API载入完成之后呢我们想要用fad in来显示列表那这个呢可以透过我们之前有提到的svelte transition的功能来做到再来我们切换标签就是我们刚刚有看到这个画面当我们在切换标签的时候我们想要重新呼叫API并且清除先前的列表好那刚刚讲的都是比较一般的场景就是比较一般的case那可能这途中我们可能会有错误状态对不对然后呢我们还想要做一个比较贴心的需求是API载入完成之前如果切换标签的话呢我们要取消前一次的请求比如说当我点下react的时候呢我的API这个搜寻react的API送出去了但是当这个API还没有载入完成的时候我就去切换标签那这时候就会送出两个请求了对不对那这个时候呢我想要把前一个请求也就是搜寻react这个请求给取消掉如果它还没有载入完成的话那这是我们想要另外做到的一个功能好那我们就直接开始吧这个感觉比较复杂了对不对那我希望呢就是我们学好这个svelte大部分的功能之后呢我们想要透过它来做一些比较实用一点的UI所以功能上也會變得比較複雜一些所以如果你還沒有熟悉Spilts裡頭的功能的話建議大家先到前11天的影片先去看一遍好 那首先我們先來看一下API我們可以透過這個API斜線search斜線repositories來找我們的這個我們要的repository然後呢我可以下幾個參數一個是q一個是sort一個是order那在這邊呢我們就簡單的用q來做實作就可以了那這個queue就是我要的search string然後呢我們在這邊看一下它的使用方式是怎麼樣所以你這邊就直接放string進來就可以了不過我們今天想要做的事情是我希望它可以根據那個repository的tag來做搜尋也就是說如果有標記react或者是fueled或者是sfilled的tag的話我們想要找出來好所以我們先來打打看api.github.com然後searchreposter對,這我之前打過好,q我們這邊就topic然後假設react好了topic react貓號react然後他就會去找這個有標記 React 的 Repository你看 第二個就是 React所以 這應該是可以動的然後 如果我們改成spells 的話呢為什麼第一個出現的是 Storybook看一下喔 看一下有沒有spells 相關的東西欸...嗯...哇 既然都沒有欸 有有有 出現一個spells material ui好所以我們先點進去看看好了感覺它應該是要有標記spells 它才會出現在我們的列表當中 我們看一下有沒有spells 有沒有spells好像有耶,有,還真的有,所以沒錯所以這個API的格式是正確的好,那我們就直接回到我們的REPL當中來試做吧首先呢,我們要有三個標籤嘛,對不對有三個標籤,我們就直接回到我們的IPL當中來實作吧首先呢我們要有三個標籤嘛對不對有三個標籤react, fill跟spell所以我們先把它放進來react, fill跟spell好那我們第一次做我們就先把全部的東西都先寫在原件當中看看然後之後我們再把它拆到我們再把API的邏輯拆到Store當中好那麼首先呢我們開一個API.js來把我們的API邏輯放在這裡面topic然後等於我們預設是react然後呢在這邊我想要做的事情是我要透過fetch或者是你想要透過比較更進階的API的話你可以用AXISAXIS我都這樣唸啦AXIS來用AXIS這個好那這邊我們就直接用原生的fetch來試做就好我們這邊先把它打出來github.com然后search然后repost应该是这样没有要打清楚reposteries然后问号q等于topictopic这样子然后呢我们刚刚有看到我们的功能这边我们想要加上一个取消的功能所以我们这边先我们可以用abortController来做到类似的功能abortController这边那这个功能比较新一点所以可能有一些浏览器还没有支援不过呢简单来说就是它可以透过fetch的方式来取消请求1000就是在比较早之前呢我们只能用AJAX的AP来做取消请求的动作那现在你可以透过AbortController来取消这个Fetch的请求

要怎麼實作呢?首先我們先宣告一個aggroach controller然後它就會有一個signal你在fetch的第二個參數可以傳送一個signal進來這樣子好了然後呢在這邊我們就直接把 res.json 給回傳過來然後如果有任何的 arrow 的話呢我們就...沒關係我們這邊就先不做處理先給大家看一下範例然後我們這邊回傳兩個東西第一個是這個 fetch那 fetch 回傳的會是一個 promise 嘛對不對所以呢第一個這邊我們先放一個 promise然後第二個我們放 controller來提供給我們的原件可以做取消API就讓我們的原件來決定什麼時候可以去呼叫好,那在這邊我們想要怎麼做呢?首先我們先把API給引入進來好的然後我們這邊先把這個Label全部給印出來好了然後我們這邊再加一個變數SelectedSelected 是一個字串好 先這樣然後 LabelsLevels然後給定一個 Button然後 Button 裡頭呢我們就直接把 Label 印出來喔 它說 Default is not exportedOK所以這邊 我們要記得把它Export出來這邊我們簡單加一個style-button-margin-rise然後呢當我點下去的時候我要做什麼事情呢我要把Selected切換成現在選取的Label然後我這邊再加一個Class Name好了ActiveSelected等於等於Label就是當我被選下的時候我就加入Active這個Class Nt然後我們這邊讓它變得明顯一點所以我們這邊就直接塞一個背景顏色紅色這樣當我選取的時候它就變成紅色好OK那再來呢我想要做到的事情是當我每次去呼叫API的時候我們這邊先先把它註解掉好了原因是因为现在每次我们的程式码更新的时候我们都会去呼叫一次API那GitHub的API打太多次的话它会给我这个red limit就是会帮我限制住API的使用所以我们等一下等我们全部的程式码都写好之后我们再试试看效果好那我这边要做到的事情是当我的selected每次更新的时候比如说从react变成few或者是当我选取了react之后呢我要去送API嘛所以呢这时候就是我们的前号要出场了大家还记得吗reactivity的assignment好然后呢我们去呼叫API的时候它会回传promise那我们这边叫response好了跟第二个是controller然后这边我们是指定了这个selected我们的参数是这个topic嘛對不對好但是我們現在這邊是都是大寫所以你這邊要記得把它變成小寫不過我在想應該是也沒有應該是也沒有關係啦就是我在想github應該也會幫你做處理不過沒關係我們這邊就一樣把它寫出來好然後呢透過這種方式啊我们就会有response跟controller这两个数这两个回传的值然后我想要透过await的语法response会是一个promise所以我们可以透过await这个语法来施作这边是放loading画面的时候然后lan的时候呢就是资料已经载入完成API已经载入完成了然後最後一個是catch arrow這邊我們就先放一個arrow就好我們等一下再來做更詳細的處理好 這樣子應該就可以了然後呢嗯我們的github回傳回來應該會是一個我把它弄掉了所以我們再看一次好了github 這邊它會是長這樣子 totalcounts 然後 items所以我們主要會去看items裡面的東西所以 each data.items.asItem然後我們這邊就給一個iditem.id所以我們直接給id當作key這個用法不知道大家還記不記得就是我們在each的最後面我們可以當作我們可以去宣告一個key讓Svelte知道說哪些列表的哪一個元素做改變了那我們只更新它就可以然後還有在這個Crossfade在做Crossfade的效果的時候Key也是必要的這邊幫大家複習然後我們這邊就把item.name然後等下喔item.description還有item.htmlurl連結好這樣子應該就可以了我們來試試看吧不然會不會成功成功了好,那我們把這邊的註解拿回來喔!有你可以發現它成功囉但是它抓出來的東西怎麼都怪怪的因為呢我的這邊的selected我其實沒有去給定一個值所以我們直接這樣寫好了讓它第一個预设值是react然后我们接下来选fuel看看看一下是不是fuel相关的东西嗯感觉应该都是fuel相关的东西然后再来是svelte好 这边应该感觉也是svelte相關的東西那我們來看一下如果假設今天沒網路也就是模擬一個錯誤的狀態或情況下會發生什麼事情你會發現它直接噴出一個arrow所以呢就是它有跳到這個block當中好,那它這邊寫type arrow fail to fetchOK,所以呢這個呢,就是我們最簡單的功能的實作好,那這個是把API的邏輯跟API的處理直接寫在原件當中嘛那麼在一些比較大型的應用當中你可能想要把這些API的處理放到其他地方做管理所以我們今天會透過Store來試做一次給大家看好,比較隆長一點,所以請大家有耐心跟著我一起做首先我們在這邊引入兩個東西一個是Writeable跟Readable從spill當中引入進來然後呢這邊我們一樣先把註解拿掉不是把註解拿掉,加上註解來避免這個你看我現在這邊call了好多次API應該是被禁止了好,沒關係然後呢我這邊先做一個selectedselected store然後呢我使用一個方法叫做set selected來讓其他的spells原件可以去更改這個store的值當然你也可以讓他們直接去使用selected store然後直接去改變這個值不過呢在這邊我想直接客製化一個方法Selected.setTopic這樣一來呢,當我在這邊把按鈕按下去的時候我就不要再這樣寫了,而是去

呼叫這個方法然後讓我的按鈕去改變這個Writeable的Store的這個值好,再來我們要實作另外一個是List要叫什麼,Repost那這個呢,這個Store我們想要把它變成是一個WriteableReadable原因是因為我並不想要其他元件去直接改變我的repos的狀態比如說status好了我想要讓我的狀態的改變都是被我的store所掌握而不是給其他元件去操作所以我這邊用readable來避免其他元件去讀取這邊我們會有idle,loading,error好然後再來呢還有什麼?items我們先給一個空正列items就是我們等一下要接的items還有什麼呢?還有error如果有錯誤的話,那現在沒有了所以我們就先給node然後呢, readable 的第二個參數是 set大家還記得嗎?第二個是 set也就是說我可以在這裡面來做我想要做的事情來避免這個從外部去改變它好,那我想要做的事情是什麼?我想要做的事情是當我的 selected也就是這個值改變的時候呢我想要去重新呼叫一次 API所以我們去 subscribe 它好,然後在這邊我想要做的事情就是我們要去實際去呼叫API啦API.Fell那這個Fell就會是react-spells或者是是甚麼?react-fill-spells然後這邊我們一樣去呼叫to lowercase然後它會回傳response跟controller好 那在這邊我想要再做一件事情是我想要去在最外頭放一個current controller來記錄我現在的請求的controller對應到的controller是誰那我這邊就先這樣子寫然後呢current controller等於controller好然後在這邊我想要先做一件事情是我要把我的這個狀態呢改成loading的狀態items一樣是清空然後error也一起清空然後response打landata這邊是我的資料已經成功載入了所以在這邊我就可以這樣子寫items已經成功載入了所以是data.items還有呢status是loaded資料已經載入了最後一個是什麼error你的資料已經成功載入了所以我們應該是不會有任何的error好然後呢我們還想要做什麼事情呢我們要做錯誤處理錯誤處理arrow如果有錯誤的話呢我們就把status改成arrow的狀態然後items設成空物件然後arrow等於arrow好這樣子應該就完成我們的功能了然後再來啊Readable 最後你可以回傳一個函數callback 那它會在什麼時候去呼叫當沒有人去訂閱這個Store的時候呢它會去呼叫 所以呢我們要記得把它unsubscribe 所以這邊當你呼叫subscribe這個函數的時候呢它會回傳unsubscribe 這個我們在之前有講過unsubscribe那這個呢是一個函數 所以我們就直接在這邊做呼叫OK這樣子就可以了好那再來我們想要做另外一件事情是我們剛剛有提到如果使用者在API載入完成前切換標籤取消前一次的請求那我們要怎麼實作這個功能呢?我們可以在這邊做首先我在這邊已經給了current controller等於controller嘛對不對所以呢我在這裡可以先做一個判斷如果有currentController的話代表前面的請求還沒有完成currentController.abroad我們就直接把它放棄拿掉然後你要記得在這邊把你的currentController清空因為你的資料已經成功載入完成了所以我們直接把它清空等於no這樣子應該就可以了我們實際試一遍看看在這邊我們就把我們程式這個留著這個拿掉這三個留著然後selected我們也把它變成store所以這個也拿掉然後這個也拿掉然後我們去我們去引入reposGripOS 跟 Selected 这两个Store还有 SetSelected 这个方法好,那这边呢它这边出现一个IllegalReassignmentToImportSelected那这个Selected已经变Store了,所以我们要这样写然後這邊也一樣OK好那這樣功能一樣是有完成的再來呢剛剛不應該全部拿掉了不過沒關係我們再重寫一次each那我們這邊要先做一個if的判斷那這個if的判斷是說repost.status如果是loading就是現在正在載入的話呢我們就一樣顯示loading的文字然後else if如果已經載入完成的話我們就對每一個items所以我說剛剛不應該全部拿掉啦現在寫起來又比較累一點readitem.nameitem.nameitem.descriptionitem.htmlurl好然後這邊呢是錯誤狀態錯誤狀態的話呢嗯一樣我們就先直接寫好我們可以直接把reports.error給列印出來好的接下來我們把這邊剛剛做了幾件東西拿回來看一下喔!成功了哇成功了有沒有看到好既然成功了讚讚讚所以我們把剛剛的同樣的功能呢把它拆到Store裡面我們就把全部的這個API的邏輯放到Store這個檔案裡頭然後呢在原件當中我們就只是把這個Store給引入進來然後單純的做一個簡單的判斷現在的狀態是什麼然後Render把它Render出來我們就只做這樣的事情而已那剩下的API的判斷就放在這裡好,那我們來看一下當我叫react的時候它會去叫react然後Fuel的時候會去叫Fuel加spelt回去加spelt好那今天我們如果把這邊開啟模擬器然後把這個網路的速度變慢的話呢我們來觀察一下當我切換這個標籤的速度比較快的話我們是不是真的會去取消前一個請求你可以發現這邊的status變成cancel也就是我成功的去呼叫了

current-controller.report來幫我做取消好 這樣user就不會送就是送請求了你看 這樣子不過呢 你會發現這邊怎麼跑出來一個奇怪的errorabort erroruser aborted a request那這是因為呢这个在文件当中里头他有写到说如果你在你在fetch当中你呼叫了controller.abort的话呢他就会去reject你的promise然后呢用这个abort arrow的方式但是我们其实并不晓得怎么做嘛因为我们知道user cancel我们是真的就是想要去取消這個請求所以我們在這邊我們在UI的顯示上我們也想要把它繼續當成loading的狀態來做那在這邊我們可以怎麼做呢第一個是我們去修改這個API.js的實作在這邊做判斷說如果我們現在的arrow是叫做abortArrow的話呢我們就一樣不要去管它或者是你也可以在store這邊做處理那我們這次就直接在store這邊做處理好了好那一樣我們先把這個註解先拿掉我們先把它註解起來以免這個API呼叫太多次好然後呢 我們在這邊在哪邊 在這邊 catch 這邊我們在這邊做一個判斷是說 如果arrow.name 等於 above arrow 的話我們就不要把它變成error狀態而是我們把它繼續弄成loading的狀態然後這邊一樣error一樣給null好這樣子的意思是說如果今天我觸發了這個取消請求的這個方法的話呢請你不要把它當成error而是當成一般的載入的狀態來做處理當然你也可以實作在這邊那我們今天就比較偷懶一點直接實作在這裡好好,那我們來再試一次看看你可以發現它的載入狀態一樣還是loadingOK好所以我們就完成了我們今天想要持座的功能了好這邊看起來的持座有點複雜對不對那麼在真正的應用場景當中可能你需要考慮的事情更多那這邊呢或者是盡量的去重現在真實場景當中我們會怎麼去處理API好那麼如果你想要讓你的API變得比如說你的場景變得更複雜的話你可以考慮用AXS或者是用RXJS去幫助你管理你的API好不過呢因為我怕這兩個再弄進來可能會讓這個焦點變得比較模糊一點所以我在這邊呢就直接用這個原生的fetch來做操作好的好 那麼我們把它儲存起來這樣呢之後大家如果有需要的話就可以參考這個範例叫什麼呢API handling好怎么突然等一下怎么突然挂掉了因为我的网路太慢了好 把它弄回来OK好 那么以上呢就是今天的教学内容啦如果有任何问题的话呢欢迎大家在YouTube或者是铁人赛的文章下方留言如果喜欢这部影片的话记得给我一个赞或者是直接订阅我的频道我是凯凯我们下次再见咯拜拜