 Hello and welcome to the video. So in this video I wanted to take you through the process of porting a vanilla JavaScript library to Svelte 4 and Svelte 5. It can be kind of a daunting task if you haven't done it before and that's why I thought it would be fun to do it together and kind of go through the thought process and what you should look out for. Let's get on with the video. Alright, I'm very excited to try to port this JavaScript project I found to Svelte today. So it's this project called Oneko JS and I have a demo of it running here. So what you can see here, it's this cute little cat that follows along with your mouse cursor and then kind of sits next to it and when you move your mouse it's gonna start chasing the mouse cursor again. Very cute. So let's see if we can get this ported to Svelte 4 and Svelte 5 today. All right, so the first thing I need to do is to create a brand new Svelte project and I'm just gonna go ahead and follow the official guide on SvelteKit docs to create a new project. I'm gonna call my project Oniko and here's gonna ask what kind of project I want and in this case I'm actually gonna choose library project because I might want to be able to publish this on on npm later so I'm just gonna pick library project here, use TypeScript and then I'm gonna add a few things that I would prefer, so like ESLint and Prettier is good to have and if we're gonna try to port this to Svelte 5, of course we're gonna need to try the Svelte 5 preview. Alright, so now I'm getting the instructions here on how to actually get started, how to install the dependencies, SvelteKit and everything, so I'm just gonna go ahead and do that. There we go. And I'm gonna init the git repo as they suggest. Then I'm going to open up the project here in VS Code. Great. Open up a new terminal, zoom in a little bit and we're just gonna see that everything is working Let see here Alright so I got my library project up and running Now we not going to go too much into like how library projects works in this video but in a library project the lib folder is what going to be your actual package and the routes folder you know where you normally have your cell kit stuff that going to be like a little demo site So we're going to be able to use that while we're developing our package and while we're porting this vanilla JavaScript package. All right. So this video is going to kind of be like a little bit trying to walk through my thought process when porting a package from JavaScript to Svelte. Like what to think about, how you do it step by step, that sort of thing. So first of all, we need to, of course, find the starting point. Like how does this vanilla JS project load? So there's this demo page and it just looks like a very basic HTML file and it's including this oneco.js script. All right, so we know that inside the script that's where all the action happens. And then I can also see here that there's this little gif file and yeah this is all the different animations for the cat. So, we're gonna want to have that in our project as well. So, what I'm gonna do is I'm gonna download these files. And I'm gonna start by downloading this GIF file and I'm gonna put it in lib images. there we go, I'm going to name it correctly, now we have that one and this JavaScript file that exists today, well we're going to rewrite it in Svelte but we're going to need it while we're porting the project. So for now what I'm going to do is I'm just going to put it here on the top level just so that we can have something to look at while we're doing the porting. All right, so I'm gonna go ahead right away and just to create a component here neko and this is gonna be where cat is going to be implemented Alright so I got this here but it not it not gonna be rendered on our demo page anywhere right now so I just need to go ahead and do that too. So I'm just gonna change the text here a little bit. I'm gonna import the component that we just created. There we go. And then, of course, we also need to render it. Let's see here. Can't forget the from keyword of course to make them import correct. Alright, there we go. So it says Svelte Necco and we have a text that says cat. But now it's time to actually port this package. And we're going to do it the way I prefer to do it is just kind of figure out first how this package works and then we're going to see how we can apply that in a svelte way. So first of all I'm just kind of looking at the general structure. So when you load this JavaScript file it has this function that it creates and then it just runs this function immediately. So this is called an iffy sometimes, immediately invoked function expression I think. And so what's going to happen when you import this file is that this code is going to run and what I'm kind of looking for here there's probably gonna be a lot of stuff here but I'm kind of looking for is the starting point so okay we have init here okay and that's good and then we have some more functions here I'm just gonna collapse them for now let's see aha there we go so at the very bottom of this immediately invoked function expression we have the init function. That seems like a great place to start our porting work. So let's see what this function does. Alright, so it has it starts with a reference to this NicoL. What is this NicoL So this must be something that is some sort of element that is created somewhere All right there we go So what happening here is that this element is being created programmatically in JavaScript and probably at some point appended to the page. Yeah, so there we can see that the element is being appended directly to the body of the page. So how do we do this in a kind of svelte way? Svelte gives us a way to create elements without having to do this sort of thing. In Svelte it's very simple. All we need to do is just create a div to start with. In order to be able to call into it programmatically we use something called bind this. So let's go ahead and define the Neko element. So let's say Neko, see here HTML div element or null because it's going to be a null when the page starts loading because this bind only happens after the hydration step in Svelte. So we created this and now we're binding it. Alright, so now for example what we can do is if we just console log this out, here we go, and we start the inspector here, reload the page, we see that we're logging out this Necco and it represents this div that we just created. So that is great. I think I might have to do this, yes, to get it to stop complaining. Now that's the first step, so we kind of did this part where we're appending it into the DOM and now what we need to do is to kind of translate some of these things into Svelte calls. So setting the ID, well we we can do that very easily. We just set the ID here to Neko. Not sure it's gonna matter later, not sure if this is used for anything. We have area hidden, we can do that as well here. There we go. And now it's setting like some different styles and you know, as you know, in Sveltec

 we have a way of handling styles. We don't have to do it programmatically. We can just create a style tag. There we go and we're gonna go ahead and create a selector, CSS selector, and now we can kind of set these different properties. So width 30 pixels, height 32 pixels, We got the position fixed. So far I'm not really even thinking so much, I'm just trying to convert what's happening here into into salt code. Pointer events, none, great. Image rendering pixelated, There we go. And then we have left and top. These ones are actually depending on some variables here, and they seem to be depending on these neck of position x and y variables. And this is something we might need to do in like a little bit of a different way. So let's continue for now. And we have the Z index and of course we can set that as well, just the CSS. Now they're setting it as number.max value. I don't know if we need to go that extreme. I think just setting it to a high value is usually enough. And then I'm kind of continuing down here. So they are referencing an image. Let's see here, so they're referencing this GIF and then a little bit later here they are setting this as the background image and we can do this in Svelte as well. The way we can do it in Svelte is by setting the background image here and we can use URL and actually inside here you You might recall that I put this file in the lib images folder, and that is because with CSS URLs we can actually reference files directly inside this folder. Look at that Isn that just super neat that we can do that All Alright and I missed over a few lines here I actually not sure what is going on here We're setting the current script variable to document.currentscript. So this is probably going to be the currently executing script element, apparently according to the docs. then if something something some data property set to cat okay I don't exactly know what this does but I'm not sure we're actually going to need this this seems like some vanilla JavaScript thing that needs to happen all right so let's go back up to these dynamic variables that are referenced so this might be a good time to look what's happening with those so they're probably defined up here somewhere. Let's go ahead and look. All right, so we have a whole bunch of variables here. We have this and how I'm thinking now is that we might as well maybe try to port these variables while we're up here. So let's just see if we can do this one by one and if there's something we need to do differently in Svelte. All right, so first one here is is reduced motion And when I'm looking at what this does, it's doing a match media query, which is a CSS media query. And if the user has this prefers reduced motion reduce set, meaning the user has actively made a choice in saying no to animations, then it sets this is reduced motion to true. otherwise um let's see here yeah so that's what it does and then um if is reduced motion to true this will actually just stop the function from executed so what this is doing here is an early return which means that if this reduced motion is true then none of this other code is even going to run so what i'm kind of getting from from this code is that the cat will not render at all if if if we have this reduced motion set. So, how can I do this in Svelte? Well we can start we can kind of create the variable here Constance is reduced motion and then we basically just just set this right But I already kind of I already see a problem here because if I save this I have a suspicion that this is not gonna gonna work. Yeah so we got this internal error. Let me see if I can zoom that in a little bit. And why are we getting this internal error you might ask? Well let's have a a look at the console here. So we get this reference error window is not defined. And the reason for this is because unlike with like vanilla JavaScript which in the case of these like kind of front-end scripts they're always run in the browser, in SvelteKit there is server-side rendering. So the components are first rendered on the server. The result of that goes to the client and then the front-end JavaScript loads, the components hydrate, and then the code kind of like runs in the browser. So the reason I was suspecting that this wouldn't work was because we're using this window.matchMedia. And when window doesn't exist on the server, so this is just going to error out as we see here in the console, So there are different ways of solving this. I kind of suspect that this is going to be just a frontend thing, so maybe the server-side rendering doesn't have to actually exist and be activated for this component. So what we can do for now is we're just going to go ahead and do we're going to set is reduced motion here to just a fixed value. Let's set it to true by default. And Svelte gives you a few ways to do things on the client. So one simple way that I think many people are familiar with is to use on mount. Let's see here. There we go and on mount will actually only run on the client. So on the server it's going to be true and on the client it's going to start being true but then on mount runs and we can set it to the correct value and this is fine because this is what we want anyway All right so let now go ahead We can see here if this is working and if we getting this reduced motion variable. All right, so first we see that we got our cat, very beautiful. It's not doing anything yet but we can see here that we're starting out with the true which is the server state that or the default state that we set and then once on mount runs we are getting false because I have not enabled this prefers reduced motion but I can actually do it here so I can set the reduced motion to prefer this motion to reduce and then if I do that then you see that it's actually true so let's see let me turn that off again. There we go. All right, so now we kind of got this working, now we need to tackle this next part which is we need to bail out if the reduced motion is enabled. And you know, again, there are many ways to do it. The way I kind of go for when I see this is maybe we don't even need to render this whole div if the reduced motion is active. So how I would kind of try to do it is just sort of if it is not reduced motion then we're gonna render the cat and so then this shouldn't even show if the motion is reduced in the browser. And we see this here. So what does this mean for server-side rendering? Well that means that this will not be basically server-side rendered, so this div won't even show up and we can kind of see this. It might be a little bit hard to see, but we can see here in the server-side response that we're getting this title that we have up here, but we're not getting the div with the cat. This is fine because this is a purely front-end, just a fun front-end feature. Great, so now we have implemented successfully these things and we also already have tackled this creation of the div element. And now we're getting

 getting down to these variables. I kind of feel like we could just take these as is. That's what's so great about Svelte, that it's kind of a super set of vanilla JavaScript, so we don't really need to do anything crazy here. So let's see here, my language server is not really collaborating here. Here we go. So we just copied in these positions, we have these mouse positions and a few other variables here, frame count, idle time, I'm sure this is going to be used for something down the line. And then also have a few consts and this tells me that these are constants, so these are actually not going to change. So very well written code in this vanilla JavaScript library signifying here that these variables won't change at runtime. So we have a speed setting, we have a a some sort of sprite sets, this is probably what controls which sprite of the GIF that is going to be shown. And that's it. All right, so now we got that squared away and then we can go back basically to this init function and see what we missed. So we missed this what we did we missed this left and top style that is controlled by the position and because they're using vanilla JavaScript they're probably updating this later and setting the style later. So how can we do this in Svelte? Well unfortunately Svelte doesn't give you like a simple way to write something like you know top you know something like this. So unfortunately Svelte doesn't let you do this but we can still use inline styles pretty easily for this sort of stuff. So let's see here, style and the co-pilot is trying to help me here. So what we want to do is, kind of like this, a little bit, gave me a little bit too much here, but Let's start with this. So, style left is the position x pixels, the top is position y pixels. So now we not only implemented this from the init method but also later on if we change these variables it actually also gonna be updated Let see how this looks So we gonna select the div here and we see here we have left 32 pixel top 32 pixel and that is the default value. So if we click here on these, yeah, these are the default values. All right. All right, so moving on we have this event listener. Okay, so how would we do something like this in Svelte? Well, we're again reaching for the on mount function because we essentially want to do something when the component mounts to hook up this event listener for the mouse movement and then we want to disconnect it if the component disappears out of the tree. This is something that probably isn't implemented in this script but we need to implement it because we have client-side routing in Svelte, so spa routing. We're not reloading the page on every request. So this is actually gonna look exactly the same. So we're gonna just go into on mount here and we're going to hook up the event listener so mouse move and I believe that let's see here there we go so we got that going and that's gonna actually update the mouse position and well let's see if this if this even works to start with. Let's try to log out the mouse position here and see how that looks. All right, yeah, it definitely seems to work. So as I'm moving the mouse, the position updates and we're getting that logged out. And the one thing we also need to do is we need to remove the event listener as well. So the way it's done in Svelte is that you can return a function, you can use on destroy, that's an option, or you can return a function from the on mount callback and that gonna actually run before the component unmounts So let go ahead and do that and what we want to do here is just basically do document.removeEventListener but yeah we need to pass the original function here and to do that, let's see here, yeah. So what we should do then is we should basically pull this function up so that we can pass the same function to the remove event listener. So, let's see, we can call this on mouseMove perhaps, keeping it simple. We're gonna maybe fix the types later, but not right now. So here I'm just gonna instead then pass the onMouseMove function. There we go and in the cleanup callback I'm going to remove the mouseMove function. Great, so we're not gonna see anything from here but we can see that it still works correctly. Great, so we're making some really good progress already, like we already kind of are very close to the end of the of the init function here and this is probably where all most of the heavy kind of like client side stuff is done. So let's continue, we just have actually just one line left, we have this request animation frame and that is calling into this function called onAnimationFrame and this is probably what's going to be doing a bunch of stuff to update the position of the cat and update probably the different animation frames that it's using and stuff like that. So we're gonna definitely need to hook this up. So let's again bring that into our onMount function. We're gonna do this and So if I recall the requestAnimationFrame returns a number which is the ID of the sort of instance of the animation frame So we need to call this something like AnimationFrameHandler, because we're also going to have to clean this up, because otherwise the animation frame would continue running even if this component disappears. from the DOM. And yeah, so what we need to do is basically to run the cancel animation frame handler. Okay, now that we've finished the init function here, we can kind of go a little bit deeper and take a look at some of the other stuff that's happening in this script. So one kind of easy thing to start with, of course, is this on animation frame function, because that is the natural next step and I'm gonna go ahead and just grab this function as it is and paste it into my component here. Great and this one gets passed a timestamp which I'm not sure if it's a number or what it actually is. Let's see here, so it's getting the, yeah according to the docs it's getting this DOM high-res timestamp and I think we should be able to to use that here. All right and then here there is some special handling for the element itself, it stops execution if the Neko element is removed. I mean we can do the same thing here, we can just kind of say if not Neko return, that's fine. Might not work exactly the same way here because we're letting Svelte handle the addition and removal of the of the element, but we can keep it like this for now, and if it causes any problems, I'm pretty sure we can just delete this. Then we have reference to this last frame timestamp variable, and I saw it here somewhere. Yeah, I saw it here. For some reason, it's not added together with all the other ones, but I think we should just

 Put it here. Okay, and that solves that problem. Yeah, okay, and then some stuff is happening. It's doing some counting. It's requesting the animation frame again, and we do want that because we want this to keep running. It's kind of the loop that runs the animation and then it calls into this function called frame. And again let's go ahead and find that function. Let's see, I don't see it. Oh, there we go, here it is. It's a pretty long function here. Let's grab all of it and paste it in to our port of this library. Okay, and let's see here, so it's doing some frame counting, it's incrementing this frame count variable, so as it runs it's gonna keep increasing and increasing. It's calculating the diff between the mouse position and the cat position, calculating the distance, then it's calling into this idle function. So we're gonna need this idle function as well. Let's put that in as well. And yeah you see now we're kind of just unwrapping the onion here because all the different functions call into each other. I'm not really changing much in these functions, I'm just kind of copying them in. So let's see, we have idle here and then this one is presumably done for, I would guess, when the cat is sitting still like this. And what is happening here, yeah, so it's doing some changes to the animation. That's great, and then it's calling the set sprite function, so maybe that's the next one we're gonna have to pull in here. Alright, and here we have also another thing I see which is that, so it's looking for the name of the sprite set and they have a bunch of names here like idle alert scratch wall and then it's actually doing something that we might want to do differently which is setting the background position. And now we can do it, like we have the element, like we have an echo element that represents the DOM here because we bound it, but again we don't need to do it like this because Svelte gives us a way to do this pretty easily. What we can do is just set it as an inline style, so if we go back down here to where we added the inline style for element. Let's see if Copilot is gonna help me here. No, not at all. Background position and let's see here. So it's setting the sprite pixel. Okay, so I think we're gonna need like a variable for this. So let's create a variable for that, that we can easily update. Background position. So this seems okay. I guess we'll see like how that's gonna work out. So, we want to set the inline style to background position. Alright, now instead of setting the background position on the DOM element, we can set the variable to the same code and that is going to then update variable, which is going to change the inline style. Quite curious to see how this actually looks now. This is not my project, this is the default one. Okay, well something is happening. So it is detecting that my mouse is moving it starts to run and then we get an error Neko L is not defined Okay this is probably something that we haven gotten to yet So let's see here, let's kind of take a step back. We were implementing this setSprite function because it was being called in idle here. Okay, we have this reset idle animation, so I'm just continuing to port different functions one by one. Okay, this seems like it's gonna work totally great, as is. Let's go back to that code. I don't see anything else here that we need to port in. So let's go back then to where idle was called. Okay, here and then we're continuing down. all of this like it is kind of what you would expect so it's there is some timing related to when the cat should move and shouldn't move, the direction the cat is running in needs to be determined and yeah actually I recognize this because this is the same as the error we had so it says nico l is not defined and that totally makes sense because nico l was the original div that was used and we changed the name of that to Nico. So that totally makes sense. What I'm thinking though is that I don't even think we need this because if you recall we changed how the property updates by using this inline style. So we don't actually need to set it. When the position changes it's going to change the inline style so if I just remove these here alright and now let's see ah this is actually looking fantastic already so the cat is running the cat is sitting it's detecting when the mouse moves yeah so you see we already getting pretty pretty close Let continue down into the code because I feel like there was some other functions here that we haven implemented yet but maybe we implemented all of it. Actually you know what we might have. So I don't see any errors and except for here which think this is some sort of type mismatch which was in the original code I don't know if we need to fix that. Let's see if I just yeah let's just restart the language server just to make sure that we got everything working and let's see Yeah, I guess that's it. I guess we ported all of it and all we need to do now is just fix the types maybe a little bit to not have these errors. And of course we need to port this to Svelte 5 as well. So, well, let's start, let's do that. All right, so now I've cleaned it up a little bit, don't have any more type errors. I did use any in some places. Please don't be too angry in the comments. Let's see if it still works the way it should. Oh, we saw the cat was sleeping there, very cute, and now it is running around and it's being super happy. Alright, so now we want to try to port this to Svelte 5 of course. First of all let's make kind of a little bit of a better demo site for us. So let's go and let's sort of make a little menu here that lets you switch between the different versions. Maybe so you can see the 4 and 5 versions separately. So I'm going to start by creating a layout. Here we go. And I'm going to just make a very, very simple menu here.

 here, that's gonna take you to home and then to the version 4 of the cat and then version 5. All right, and yeah, that looks great. And then now let's create these routes for 4 and 5. So, 4 and here we just want to import the cat that we already have. There we go, So if we go to salt 4 now, yep the cat is still there. That's also something that I'm looking at here and to see if it's being cleaned up correctly and it seems like it is because I have no problem initializing and re-initializing the cat without any errors or any warnings and now let's create the page for the 5 version and here we're gonna do the same thing, we're gonna import but we're gonna make a new component, we're gonna call it Necco 5 and that means I need to make a component here and yeah we're gonna start by basically starting from the version 4 component and porting that to Svelte 5. But first I did actually see one little bug here that the eagle-eyed viewer must have seen, might have seen, which is that when the page loads the initial version of the cat is this, this where the cat is kind of like running upwards. I don't think it was like that on this version. Well actually it is, but I think it would kind be better if the first frame that was shown was the cats just sitting. And I think this is related to the background position because what happens basically in this with all these different animations is that they change the background position. So if we look here how background position works, it taking the index of the sprite and multiplies that by 32 And that has to do with this image So the way I understand this is that every one of these little frames is 32 by 32 and by changing like the kind of offset like you know three times 32 then you gonna end up here or four times some other the other in the other axis you're gonna get this one and that's how you get the correct frame. So the reason that it is this up position is probably because we're setting the background to zero zero which is giving us this position here. So let's see if we can fix that first before we start with the salt 5 version. So if I recall yeah we were setting this background position here we're setting it to zero zero but like what happens if we set it to 32 zero for example then what? Okay then we get this one where the cat is kind of taking his paw up and what what image is that? It's this one okay so yeah now it's just kind of a question of trying to find the correct position of the of the frame we want to start with so we want to have so this is 32 i have no idea which direction is is which uh if i do like 64 now it's gonna be the one with the back paw which is this one so this seems to be moving us into this direction so we need like so if you want if you want to kind of be let's see here is the default position so So if we want to be here, we need to be like one, two, three, four, five, maybe. One, one 60 pixels. Okay. And then, then we should get one, two, three, four, five. We should get this one now. Yeah. And we do get that little cat mid jump. And now we need to also like do the same, but actually go down here. So I not doing any sort of complicated math I just kind of trying to do it by just experimenting here So let try like if we go 16 pixel sorry 32 pixel here are we gonna get this picture, I wonder? No, no, actually, actually we got the one we wanted, we got the sitting one. I don't know exactly how these x and y coordinates work, but it does seem to work correctly. So now happy. Now we got the cat sitting from the start and then the cat is correctly starts to run around. Great, so we're very close. Let's try to do the Svelte 5 version. Now disclaimer, I haven't worked that much with the Svelte 5 and I did have to look up the Svelte 5 preview docs a little bit before this. I would recommend, if you are also excited to try five, I would recommend just kind of running through these docs to start with, because they're very good at introducing the different runes, the new runes concept, and all the different runes that exist. I don't think we're gonna need that much of this sort of thing. We don't have any sort of complex external state or anything like that. I think we're probably be able to get away with mostly just the stateroom, but let's see. So first of all I'm gonna take the self-for code and I'm gonna paste it into the new component and I'm gonna see how that works. Yeah, that does still work because I think we switched the component. Yes, we did. So now we're on the Svelte 5 cat page. And I do think that we also need to enable this runes mode. I don't know exactly if runes mode enables by itself or if you actually always have to enable runes mode, but we need to add this little Svelte options thing here and once we do this I do count on it not working anymore because we no longer allowed to modify the state like it Svelte for and actually see some errors here it says Nico is updated but it not declared with state IsReduceMotion is updated but it not declared with state So yeah I kind of count on this yeah not working at all No errors but it's not working. So yeah so that's that's what we're gonna have to do. We're gonna have to make this into state and the way you do this is you use the state rune and in case you don't know runes are part of the language so there's no there's no import that you have to do also the I think that the types work a little bit differently with with the runes in how you enter them Let's see if there is an example. I don't see an example, but I think you do it like this, so you pass it the type here, and let's see if that works. Yeah, so that correctly then infers the type. Okay, and then yes, it's pretty mechanical. We just need to wrap these into state runes. Okay, so pretty mechanical just converting them all. Last frame timestamp, it's probably a number right? So let's do state number zero. Okay, and of course, yeah, we're gonna need to do this for the background position as well. I wonder if it's smart enough. Yeah, it is smart enough to infer that because we passed the string here as the default value, it's gonna assume there's gonna be a string. All right, no problems anymore. That's good. Let's see if it works. Ah, fantastic! So it's maybe a little bit hard to see up here, it's very small, but we are on the version 5. And it works, and it works and it's running using

 runes, so that wasn't so hard. Now is there anything else we can do to make it a little bit more Svelte 5? I think there is one thing we could do, which is with on mount. So Svelte 5 has a new feature, a new rune rather, called Effect. And Effect, it is, yeah, you can read more about Effect in the docs, but it is for side effects, but it has kind of a little bit like the useEffect function in React, but it also has this property where it will run just like useEffect in React, it will run when the component mounts, and in Svelte 5 it's going to run only on the client. So it actually in a way replaces onMount, so I would be curious to see if we can do the same thing here as we're doing it on mount but using effect. And I do believe that the cleanup is actually also handled in the in exactly the same way. So you return a function and that runs when the component unmounts And we can actually even test this so we can say here unmounting cat Here we go Okay so I completely replaced the unmount function there Let see here so that does still work That tells me that it is still running these mouse event listener and stuff. And if I go to home, yes, I'm getting this unmounting cat. So the cleanup also seems to work correctly. Great! So I think we did what we set out to do and now of course we could take this further. Because we created this as a library project we could actually publish our component to something like npm. So SvelteKit has this docs page called packaging and it explains everything about how the library projects work. So if that's something that you'd be interested in seeing next leave a comment and let me know. Thanks! Thanks so much for watching the video and for sticking through to the end. It really means a lot to me. So I'd like to try some new things here on the channel so if there's some Svelte video that you would like to see but you haven't seen around please feel free to leave a comment and I'll try to make it. Thanks again for watching.