# 1.2 â€” Arquitetura do Vite

> Entenda como o Vite funciona internamente: servidor de desenvolvimento, prÃ©-bundling e o papel do esbuild e Rollup.

## Objetivos da Aula

- Compreender a arquitetura interna do servidor de desenvolvimento
- Entender o processo de prÃ©-bundling de dependÃªncias com esbuild
- Conhecer o fluxo de transformaÃ§Ã£o de arquivos
- Diferenciar o funcionamento em desenvolvimento vs produÃ§Ã£o

---

## VisÃ£o Geral da Arquitetura

O Vite possui duas arquiteturas distintas que trabalham em conjunto:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ARQUITETURA DO VITE                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚   DESENVOLVIMENTO   â”‚      â”‚      PRODUÃ‡ÃƒO       â”‚             â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
â”‚   â”‚                     â”‚      â”‚                     â”‚             â”‚
â”‚   â”‚  Servidor ESM       â”‚      â”‚  Rollup Bundler     â”‚             â”‚
â”‚   â”‚  + esbuild          â”‚      â”‚  + Plugins          â”‚             â”‚
â”‚   â”‚  + HMR nativo       â”‚      â”‚  + OtimizaÃ§Ãµes      â”‚             â”‚
â”‚   â”‚                     â”‚      â”‚                     â”‚             â”‚
â”‚   â”‚  npm run dev        â”‚      â”‚  npm run build      â”‚             â”‚
â”‚   â”‚                     â”‚      â”‚                     â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## O Servidor de Desenvolvimento

### Fluxo de uma RequisiÃ§Ã£o

Quando vocÃª acessa `http://localhost:5173`, acontece o seguinte:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLUXO DE REQUISIÃ‡ÃƒO                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  1. Navegador                2. Servidor Vite                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ GET /       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Serve index.html â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                      â”‚                               â”‚
â”‚  3. Navegador encontra              â”‚                               â”‚
â”‚     <script type="module"           â”‚                               â”‚
â”‚      src="/src/main.js">            â”‚                               â”‚
â”‚                                      â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚GET /src/    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Transforma       â”‚                    â”‚
â”‚  â”‚  main.js    â”‚            â”‚ main.js sob      â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ demanda          â”‚                    â”‚
â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                      â”‚                               â”‚
â”‚  4. Navegador recebe main.js        â”‚                               â”‚
â”‚     encontra: import './app.js'     â”‚                               â”‚
â”‚                                      â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚GET /src/    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Transforma       â”‚                    â”‚
â”‚  â”‚  app.js     â”‚            â”‚ app.js sob       â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ demanda          â”‚                    â”‚
â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                      â”‚
â”‚  E assim por diante para cada import...                             â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CÃ³digo Exemplo: Vendo na PrÃ¡tica

Crie estes arquivos no seu projeto:

```javascript
// src/main.js
import { saudacao } from './utils/saudacao.js'
import { formataData } from './utils/data.js'

console.log(saudacao('Mundo'))
console.log(formataData(new Date()))
```

```javascript
// src/utils/saudacao.js
export function saudacao(nome) {
  return `OlÃ¡, ${nome}!`
}
```

```javascript
// src/utils/data.js
export function formataData(data) {
  return data.toLocaleDateString('pt-BR')
}
```

Abra o **DevTools do navegador** â†’ **Network** e observe:

```
Request 1: /src/main.js         (200 OK)
Request 2: /src/utils/saudacao.js (200 OK)
Request 3: /src/utils/data.js     (200 OK)
```

Cada arquivo Ã© uma requisiÃ§Ã£o separada! O navegador resolve os imports.

---

## PrÃ©-bundling de DependÃªncias

### O Problema com node_modules

Nem todas as dependÃªncias funcionam bem com ESModules nativos:

```javascript
// lodash tem centenas de mÃ³dulos internos
import { debounce } from 'lodash-es'
// Isso causaria CENTENAS de requisiÃ§Ãµes HTTP!

// react usa CommonJS internamente
import React from 'react'
// CommonJS nÃ£o funciona direto no navegador!
```

### A SoluÃ§Ã£o: esbuild

O Vite usa o **esbuild** para prÃ©-compilar dependÃªncias no primeiro start:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PRÃ‰-BUNDLING                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   Primeiro npm run dev:                                             â”‚
â”‚                                                                     â”‚
â”‚   node_modules/                    node_modules/.vite/deps/         â”‚
â”‚   â”œâ”€â”€ lodash-es/                   â”œâ”€â”€ lodash-es.js    (1 arquivo)  â”‚
â”‚   â”‚   â”œâ”€â”€ debounce.js    â”€â”€â”€â”€â–¶    â”‚                                â”‚
â”‚   â”‚   â”œâ”€â”€ throttle.js             â”‚                                â”‚
â”‚   â”‚   â”œâ”€â”€ ...300+ files           â”‚                                â”‚
â”‚   â”‚                                â”‚                                â”‚
â”‚   â””â”€â”€ react/                       â””â”€â”€ react.js        (1 arquivo)  â”‚
â”‚       â”œâ”€â”€ index.js       â”€â”€â”€â”€â–¶        (CommonJS â†’ ESM)             â”‚
â”‚       â”œâ”€â”€ cjs/                                                      â”‚
â”‚       â””â”€â”€ ...                                                       â”‚
â”‚                                                                     â”‚
â”‚   âš¡ esbuild faz isso em ~100ms                                     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Vendo o Cache

ApÃ³s rodar `npm run dev`, observe a pasta criada:

```bash
ls node_modules/.vite/deps/
```

VocÃª verÃ¡ arquivos como:
```
_metadata.json
lodash-es.js
lodash-es.js.map
react.js
react.js.map
```

### Reescrita de Imports

O Vite reescreve seus imports automaticamente:

```javascript
// Seu cÃ³digo (o que vocÃª escreve):
import { debounce } from 'lodash-es'

// O que o navegador recebe:
import { debounce } from '/node_modules/.vite/deps/lodash-es.js?v=abc123'
```

---

## Hot Module Replacement (HMR)

### Como Funciona

O HMR do Vite usa WebSockets para comunicaÃ§Ã£o instantÃ¢nea:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          HMR FLOW                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   1. VocÃª edita: src/components/Button.js                           â”‚
â”‚                                                                     â”‚
â”‚   2. Vite detecta a mudanÃ§a (chokidar file watcher)                â”‚
â”‚                                                                     â”‚
â”‚   3. Vite envia via WebSocket:                                      â”‚
â”‚      {                                                              â”‚
â”‚        type: 'update',                                              â”‚
â”‚        updates: [{                                                  â”‚
â”‚          path: '/src/components/Button.js',                         â”‚
â”‚          timestamp: 1699123456789                                   â”‚
â”‚        }]                                                           â”‚
â”‚      }                                                              â”‚
â”‚                                                                     â”‚
â”‚   4. Cliente Vite (no navegador):                                   â”‚
â”‚      - Recebe a mensagem                                            â”‚
â”‚      - Faz import() dinÃ¢mico do mÃ³dulo atualizado                  â”‚
â”‚      - Substitui o mÃ³dulo antigo pelo novo                         â”‚
â”‚      - Estado da aplicaÃ§Ã£o Ã© PRESERVADO!                           â”‚
â”‚                                                                     â”‚
â”‚   â±ï¸ Tempo total: 10-20ms                                           â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Exemplo: Observando o HMR

Abra o DevTools â†’ Console e observe as mensagens:

```
[vite] connecting...
[vite] connected.

# Quando vocÃª edita um arquivo:
[vite] hot updated: /src/main.js
```

### API do HMR

VocÃª pode interagir com o HMR programaticamente:

```javascript
// main.js
import { contador } from './contador.js'

console.log('Contagem:', contador)

// API de HMR do Vite
if (import.meta.hot) {
  // Aceita atualizaÃ§Ãµes deste mÃ³dulo
  import.meta.hot.accept()

  // Executa quando o mÃ³dulo Ã© substituÃ­do
  import.meta.hot.dispose(() => {
    console.log('MÃ³dulo antigo sendo descartado')
  })
}
```

---

## TransformaÃ§Ã£o de Arquivos

### Pipeline de TransformaÃ§Ã£o

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PIPELINE DE TRANSFORMAÃ‡ÃƒO                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   Arquivo Fonte                                                     â”‚
â”‚       â”‚                                                             â”‚
â”‚       â–¼                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚   â”‚ Resolve Imports â”‚  Reescreve bare imports                      â”‚
â”‚   â”‚ (ex: 'lodash')  â”‚  para caminhos vÃ¡lidos                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚            â”‚                                                        â”‚
â”‚            â–¼                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚   â”‚   Plugins       â”‚  Plugins transformam o cÃ³digo                â”‚
â”‚   â”‚   (opcional)    â”‚  (TypeScript, JSX, Vue, Svelte)              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚            â”‚                                                        â”‚
â”‚            â–¼                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚   â”‚     esbuild     â”‚  Transpila TS/JSX se necessÃ¡rio              â”‚
â”‚   â”‚   (se TS/JSX)   â”‚  (10-100x mais rÃ¡pido que Babel)             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚            â”‚                                                        â”‚
â”‚            â–¼                                                        â”‚
â”‚   CÃ³digo ESM pronto para o navegador                               â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Exemplo: TypeScript

```typescript
// src/utils/math.ts
export function soma(a: number, b: number): number {
  return a + b
}
```

O Vite transforma para:

```javascript
// O que o navegador recebe:
export function soma(a, b) {
  return a + b
}
```

A transformaÃ§Ã£o acontece **sob demanda**, nÃ£o antecipadamente!

---

## Arquitetura de ProduÃ§Ã£o

No build de produÃ§Ã£o, o Vite usa **Rollup**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BUILD DE PRODUÃ‡ÃƒO                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   npm run build                                                     â”‚
â”‚                                                                     â”‚
â”‚   src/                              dist/                           â”‚
â”‚   â”œâ”€â”€ main.js                       â”œâ”€â”€ index.html                  â”‚
â”‚   â”œâ”€â”€ app.js          â”€â”€â”€â”€â”€â”€â”€â”€â–¶    â”œâ”€â”€ assets/                     â”‚
â”‚   â”œâ”€â”€ utils/                        â”‚   â”œâ”€â”€ main-a1b2c3.js         â”‚
â”‚   â””â”€â”€ styles.css                    â”‚   â””â”€â”€ style-d4e5f6.css       â”‚
â”‚                                     â””â”€â”€ vite.svg                    â”‚
â”‚                                                                     â”‚
â”‚   Rollup aplica:                                                    â”‚
â”‚   âœ“ Tree-shaking (remove cÃ³digo nÃ£o usado)                         â”‚
â”‚   âœ“ MinificaÃ§Ã£o (reduz tamanho)                                    â”‚
â”‚   âœ“ Code splitting (divide em chunks)                              â”‚
â”‚   âœ“ Hashing (cache busting)                                        â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Por que Rollup e nÃ£o esbuild para produÃ§Ã£o?

```
esbuild:
âœ“ Extremamente rÃ¡pido
âœ— Code splitting ainda nÃ£o Ã© ideal
âœ— Plugins menos flexÃ­veis

Rollup:
âœ“ Code splitting maduro
âœ“ Ecossistema de plugins robusto
âœ“ OtimizaÃ§Ãµes avanÃ§adas
âœ— Mais lento (mas OK para builds ocasionais)
```

---

## Exemplo PrÃ¡tico: Observando a Arquitetura

### 1. Veja o prÃ©-bundling acontecendo

```bash
# Delete o cache
rm -rf node_modules/.vite

# Rode o dev server e observe o terminal
npm run dev
```

VocÃª verÃ¡:
```
Optimizing dependencies:
  lodash-es, react, react-dom
Pre-bundling them to speed up dev server page load...
```

### 2. Compare dev vs build

```bash
# Em desenvolvimento
npm run dev
# Abra DevTools â†’ Network â†’ observe dezenas de arquivos .js

# Para build
npm run build
# Observe a pasta dist/ â†’ poucos arquivos otimizados
```

### 3. Inspecione o output do build

```bash
npm run build
cat dist/assets/index-*.js | head -20
# CÃ³digo minificado e otimizado!
```

---

## ğŸ¯ Mini-Projeto: ContinuaÃ§Ã£o

Vamos adicionar **monitoramento de HMR** ao nosso Dashboard:

### Arquivo: src/hmr-monitor.js

```javascript
// src/hmr-monitor.js
// Monitor de atualizaÃ§Ãµes HMR

const atualizacoes = []

export function registrarAtualizacao(path) {
  atualizacoes.push({
    path,
    timestamp: new Date().toLocaleTimeString('pt-BR')
  })
}

export function getAtualizacoes() {
  return [...atualizacoes]
}

export function getUltimaAtualizacao() {
  return atualizacoes[atualizacoes.length - 1] || null
}

// Configura listener de HMR
if (import.meta.hot) {
  // Quando QUALQUER mÃ³dulo for atualizado
  import.meta.hot.on('vite:beforeUpdate', (payload) => {
    payload.updates.forEach(update => {
      registrarAtualizacao(update.path)
      console.log(`ğŸ”„ HMR: ${update.path}`)
    })
  })
}
```

### Atualize o main.js

```javascript
// main.js
import './style.css'
import { setupCounter } from './counter.js'
import { getAtualizacoes, getUltimaAtualizacao } from './hmr-monitor.js'

const inicioCarregamento = performance.now()

function renderApp() {
  const atualizacoes = getAtualizacoes()
  const ultima = getUltimaAtualizacao()

  document.querySelector('#app').innerHTML = `
    <div>
      <a href="https://vitejs.dev" target="_blank">
        <img src="/vite.svg" class="logo" alt="Vite logo" />
      </a>
      <h1>Dashboard Vite</h1>

      <div class="card">
        <button id="counter" type="button"></button>
      </div>

      <div class="stats">
        <p id="tempo-carregamento">Calculando...</p>
        <p id="hmr-stats">
          ğŸ“Š HMR Updates: ${atualizacoes.length}
          ${ultima ? `<br>Ãšltimo: ${ultima.path} Ã s ${ultima.timestamp}` : ''}
        </p>
      </div>
    </div>
  `

  setupCounter(document.querySelector('#counter'))

  requestAnimationFrame(() => {
    const fimCarregamento = performance.now()
    const tempoTotal = (fimCarregamento - inicioCarregamento).toFixed(2)
    document.querySelector('#tempo-carregamento').textContent =
      `âš¡ Carregado em ${tempoTotal}ms`
  })
}

renderApp()

// Aceita HMR e re-renderiza
if (import.meta.hot) {
  import.meta.hot.accept(() => {
    renderApp()
  })
}
```

### Teste o HMR

1. Rode `npm run dev`
2. Abra o navegador em `http://localhost:5173`
3. Edite qualquer arquivo e salve
4. Observe o contador de HMR aumentar!

---

## âœ… Desafio da Aula

### Objetivo
Criar um componente que mostra o tempo de cada atualizaÃ§Ã£o HMR.

### InstruÃ§Ãµes

1. Modifique `hmr-monitor.js` para tambÃ©m registrar **quanto tempo** cada HMR levou
2. Use `performance.now()` para medir o tempo entre o inÃ­cio e fim do HMR
3. Exiba a mÃ©dia de tempo de HMR no dashboard

### Dica

```javascript
// VocÃª pode usar estes eventos do HMR:
import.meta.hot.on('vite:beforeUpdate', () => { /* antes */ })
import.meta.hot.on('vite:afterUpdate', () => { /* depois */ })
```

### Spec de VerificaÃ§Ã£o

- [ ] O dashboard mostra quantas atualizaÃ§Ãµes HMR ocorreram
- [ ] O dashboard mostra o tempo mÃ©dio das atualizaÃ§Ãµes
- [ ] Ao editar um arquivo, os nÃºmeros atualizam automaticamente

### SoluÃ§Ã£o

<details>
<summary>ğŸ” Clique para ver a soluÃ§Ã£o</summary>

```javascript
// src/hmr-monitor.js
const atualizacoes = []
let hmrInicio = null

export function registrarInicio() {
  hmrInicio = performance.now()
}

export function registrarFim(path) {
  if (hmrInicio) {
    const duracao = performance.now() - hmrInicio
    atualizacoes.push({
      path,
      timestamp: new Date().toLocaleTimeString('pt-BR'),
      duracao: duracao.toFixed(2)
    })
    hmrInicio = null
  }
}

export function getAtualizacoes() {
  return [...atualizacoes]
}

export function getMediaTempo() {
  if (atualizacoes.length === 0) return 0
  const soma = atualizacoes.reduce((acc, a) => acc + parseFloat(a.duracao), 0)
  return (soma / atualizacoes.length).toFixed(2)
}

if (import.meta.hot) {
  import.meta.hot.on('vite:beforeUpdate', () => {
    registrarInicio()
  })

  import.meta.hot.on('vite:afterUpdate', (payload) => {
    payload.updates.forEach(update => {
      registrarFim(update.path)
      console.log(`ğŸ”„ HMR: ${update.path}`)
    })
  })
}
```

</details>

---

## ğŸ“š Recursos Adicionais

- [Dependency Pre-Bundling - Vite Docs](https://vite.dev/guide/dep-pre-bundling)
- [HMR API - Vite Docs](https://vite.dev/guide/api-hmr)
- [How Vite Works - esbuild docs](https://esbuild.github.io/)

---

**PrÃ³xima aula:** [1.3 â€” Criando e Explorando um Projeto Vite](./1.3-criando-projeto-vite.md)
