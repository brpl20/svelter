# 1.6 â€” VariÃ¡veis de Ambiente e Modos

> Configure diferentes ambientes (dev, staging, produÃ§Ã£o) com variÃ¡veis seguras.

## Objetivos da Aula

- Entender o sistema de variÃ¡veis de ambiente do Vite
- Criar arquivos `.env` para diferentes ambientes
- Diferenciar variÃ¡veis pÃºblicas e privadas
- Usar modos customizados

---

## Como VariÃ¡veis de Ambiente Funcionam

O Vite usa arquivos `.env` para definir variÃ¡veis de ambiente:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ARQUIVOS .env                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  .env                 â†’ Carregado em TODOS os casos                 â”‚
â”‚  .env.local           â†’ Carregado em todos, ignorado pelo git       â”‚
â”‚  .env.[mode]          â†’ Carregado apenas no modo especificado       â”‚
â”‚  .env.[mode].local    â†’ Carregado no modo, ignorado pelo git        â”‚
â”‚                                                                     â”‚
â”‚  Ordem de prioridade (maior para menor):                            â”‚
â”‚  1. .env.[mode].local                                               â”‚
â”‚  2. .env.[mode]                                                     â”‚
â”‚  3. .env.local                                                      â”‚
â”‚  4. .env                                                            â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Modos PadrÃ£o

| Comando | Modo |
|---------|------|
| `vite` / `vite dev` | `development` |
| `vite build` | `production` |
| `vite preview` | `production` |

---

## Criando Arquivos .env

### `.env` â€” Base (todos os ambientes)

```bash
# .env
# VariÃ¡veis compartilhadas entre todos os ambientes

# PÃšBLICAS (acessÃ­veis no cliente)
VITE_APP_NAME=Dashboard Vite
VITE_APP_VERSION=1.0.0

# PRIVADAS (sÃ³ no servidor/build)
DATABASE_URL=postgresql://localhost:5432/mydb
SECRET_KEY=minha-chave-secreta
```

### `.env.development` â€” Desenvolvimento

```bash
# .env.development
# Sobrescreve .env quando mode=development

VITE_API_URL=http://localhost:8080/api
VITE_DEBUG=true

# Banco de dev
DATABASE_URL=postgresql://localhost:5432/mydb_dev
```

### `.env.production` â€” ProduÃ§Ã£o

```bash
# .env.production
# Sobrescreve .env quando mode=production

VITE_API_URL=https://api.meuprojeto.com
VITE_DEBUG=false

# Banco de produÃ§Ã£o (nunca commite senhas reais!)
DATABASE_URL=postgresql://prod-server:5432/mydb_prod
```

### `.env.local` â€” Local (nÃ£o commitado)

```bash
# .env.local
# NUNCA vai para o git - para secrets locais

# Chaves pessoais de API
VITE_MAPS_API_KEY=sua-chave-pessoal-aqui
GITHUB_TOKEN=ghp_xxxxxxxxxxxx
```

### `.gitignore`

```bash
# .gitignore
.env.local
.env.*.local
```

---

## Acessando VariÃ¡veis

### No Cliente (VITE_ prefix)

**Importante:** Apenas variÃ¡veis com prefixo `VITE_` sÃ£o expostas ao cliente!

```javascript
// âœ… Funciona - tem prefixo VITE_
console.log(import.meta.env.VITE_APP_NAME)
console.log(import.meta.env.VITE_API_URL)

// âŒ undefined - sem prefixo VITE_
console.log(import.meta.env.DATABASE_URL) // undefined
console.log(import.meta.env.SECRET_KEY)   // undefined
```

### VariÃ¡veis AutomÃ¡ticas

```javascript
// VariÃ¡veis sempre disponÃ­veis
import.meta.env.MODE       // 'development' ou 'production'
import.meta.env.BASE_URL   // URL base (config.base)
import.meta.env.PROD       // true se production
import.meta.env.DEV        // true se development
import.meta.env.SSR        // true se server-side rendering
```

### Exemplo PrÃ¡tico

```javascript
// src/config.js
export const config = {
  appName: import.meta.env.VITE_APP_NAME,
  apiUrl: import.meta.env.VITE_API_URL,
  debug: import.meta.env.VITE_DEBUG === 'true',
  isDev: import.meta.env.DEV,
  isProd: import.meta.env.PROD,
  mode: import.meta.env.MODE
}

// Uso condicional
if (config.isDev) {
  console.log('Modo desenvolvimento')
  console.log('Config:', config)
}

// API URL dinÃ¢mica
async function fetchData(endpoint) {
  const url = `${config.apiUrl}/${endpoint}`
  return fetch(url).then(r => r.json())
}
```

---

## TypeScript e VariÃ¡veis de Ambiente

### Tipagem das VariÃ¡veis

Crie um arquivo de tipos:

```typescript
// src/vite-env.d.ts
/// <reference types="vite/client" />

interface ImportMetaEnv {
  readonly VITE_APP_NAME: string
  readonly VITE_APP_VERSION: string
  readonly VITE_API_URL: string
  readonly VITE_DEBUG: string
  readonly VITE_MAPS_API_KEY?: string
}

interface ImportMeta {
  readonly env: ImportMetaEnv
}
```

Agora vocÃª tem autocomplete!

```typescript
// TypeScript sabe que essas variÃ¡veis existem
const apiUrl = import.meta.env.VITE_API_URL // string
const debug = import.meta.env.VITE_DEBUG    // string
```

---

## Modos Customizados

### Criando um Modo Staging

```bash
# .env.staging
VITE_APP_NAME=Dashboard Vite (Staging)
VITE_API_URL=https://staging-api.meuprojeto.com
VITE_DEBUG=true
```

```json
// package.json
{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "build:staging": "vite build --mode staging",
    "preview": "vite preview"
  }
}
```

### Modo de Preview/QA

```bash
# .env.preview
VITE_APP_NAME=Dashboard Vite (Preview)
VITE_API_URL=https://preview-api.meuprojeto.com
VITE_FEATURE_FLAGS={"newUI":true,"betaFeatures":true}
```

```json
{
  "scripts": {
    "build:preview": "vite build --mode preview"
  }
}
```

---

## Usando no vite.config.js

### Carregando VariÃ¡veis na Config

```javascript
// vite.config.js
import { defineConfig, loadEnv } from 'vite'

export default defineConfig(({ mode }) => {
  // Carrega variÃ¡veis de ambiente
  // process.cwd() = diretÃ³rio atual
  // '' = prefixo vazio (carrega TODAS as variÃ¡veis)
  const env = loadEnv(mode, process.cwd(), '')

  console.log(`Modo: ${mode}`)
  console.log(`API URL: ${env.VITE_API_URL}`)

  return {
    define: {
      // Injeta variÃ¡veis customizadas (cuidado com seguranÃ§a!)
      __APP_VERSION__: JSON.stringify(env.VITE_APP_VERSION)
    },

    server: {
      proxy: {
        '/api': {
          target: env.VITE_API_URL,
          changeOrigin: true
        }
      }
    }
  }
})
```

### VariÃ¡veis em Tempo de Build

```javascript
// vite.config.js
import { defineConfig } from 'vite'

export default defineConfig({
  define: {
    // DisponÃ­veis em todo o cÃ³digo
    __BUILD_TIME__: JSON.stringify(new Date().toISOString()),
    __COMMIT_HASH__: JSON.stringify(process.env.COMMIT_SHA || 'local')
  }
})
```

```javascript
// No cÃ³digo
console.log(`Build: ${__BUILD_TIME__}`)
console.log(`Commit: ${__COMMIT_HASH__}`)
```

---

## SubstituiÃ§Ã£o de VariÃ¡veis em HTML

### index.html

```html
<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>%VITE_APP_NAME%</title>
    <meta name="version" content="%VITE_APP_VERSION%">
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.js"></script>
  </body>
</html>
```

O Vite substitui `%VITE_*%` automaticamente!

---

## SeguranÃ§a

### âš ï¸ Regras Importantes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SEGURANÃ‡A DE VARIÃVEIS                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  âœ… VITE_ (pÃºblico)     â†’  VisÃ­vel no navegador, ok expor           â”‚
â”‚     - URLs de API pÃºblicas                                          â”‚
â”‚     - Nomes de app                                                  â”‚
â”‚     - Feature flags pÃºblicos                                        â”‚
â”‚     - Chaves de API pÃºblicas (Google Maps, etc)                    â”‚
â”‚                                                                     â”‚
â”‚  âŒ SEM PREFIXO (privado) â†’ NUNCA exposto, seguro                   â”‚
â”‚     - Senhas de banco                                               â”‚
â”‚     - Tokens de autenticaÃ§Ã£o                                        â”‚
â”‚     - Chaves secretas                                               â”‚
â”‚     - API keys privadas                                             â”‚
â”‚                                                                     â”‚
â”‚  ğŸš¨ NUNCA faÃ§a:                                                     â”‚
â”‚     - VITE_DATABASE_PASSWORD=...                                    â”‚
â”‚     - VITE_STRIPE_SECRET_KEY=...                                    â”‚
â”‚     - Commitar .env.local                                           â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ValidaÃ§Ã£o de VariÃ¡veis

```javascript
// src/env.js
// Valida que todas as variÃ¡veis necessÃ¡rias existem

const requiredEnvVars = [
  'VITE_APP_NAME',
  'VITE_API_URL'
]

for (const envVar of requiredEnvVars) {
  if (!import.meta.env[envVar]) {
    throw new Error(`VariÃ¡vel de ambiente ${envVar} nÃ£o definida!`)
  }
}

export const env = {
  appName: import.meta.env.VITE_APP_NAME,
  apiUrl: import.meta.env.VITE_API_URL,
  debug: import.meta.env.VITE_DEBUG === 'true',
  isDev: import.meta.env.DEV,
  isProd: import.meta.env.PROD
}
```

---

## ğŸ¯ Mini-Projeto: ConfiguraÃ§Ã£o Multi-Ambiente

Vamos configurar nosso Dashboard para mÃºltiplos ambientes:

### Passo 1: Criar arquivos .env

```bash
# .env
VITE_APP_NAME=Dashboard Vite
VITE_APP_VERSION=1.0.0
```

```bash
# .env.development
VITE_API_URL=http://localhost:3001
VITE_DEBUG=true
VITE_ENVIRONMENT=development
```

```bash
# .env.staging
VITE_API_URL=https://staging-api.example.com
VITE_DEBUG=true
VITE_ENVIRONMENT=staging
```

```bash
# .env.production
VITE_API_URL=https://api.example.com
VITE_DEBUG=false
VITE_ENVIRONMENT=production
```

### Passo 2: Criar mÃ³dulo de configuraÃ§Ã£o

```javascript
// src/config/env.js

// ValidaÃ§Ã£o
const required = ['VITE_APP_NAME', 'VITE_API_URL']
for (const key of required) {
  if (!import.meta.env[key]) {
    console.error(`âŒ VariÃ¡vel ${key} nÃ£o definida!`)
  }
}

// Exporta configuraÃ§Ã£o tipada
export const env = {
  app: {
    name: import.meta.env.VITE_APP_NAME,
    version: import.meta.env.VITE_APP_VERSION || '0.0.0'
  },
  api: {
    url: import.meta.env.VITE_API_URL
  },
  flags: {
    debug: import.meta.env.VITE_DEBUG === 'true'
  },
  runtime: {
    mode: import.meta.env.MODE,
    isDev: import.meta.env.DEV,
    isProd: import.meta.env.PROD,
    environment: import.meta.env.VITE_ENVIRONMENT || 'unknown'
  }
}

// Log em desenvolvimento
if (env.flags.debug) {
  console.log('ğŸ”§ ConfiguraÃ§Ã£o carregada:', env)
}
```

### Passo 3: Componente de status do ambiente

```javascript
// src/components/EnvironmentBadge.js

import { env } from '@/config/env.js'

const colors = {
  development: '#22c55e', // verde
  staging: '#f59e0b',     // amarelo
  production: '#ef4444'   // vermelho
}

export function createEnvironmentBadge() {
  const badge = document.createElement('div')
  badge.className = 'environment-badge'
  badge.style.cssText = `
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    background: ${colors[env.runtime.environment] || '#666'};
    color: white;
    z-index: 9999;
  `
  badge.textContent = `${env.runtime.environment} â€¢ v${env.app.version}`

  // NÃ£o mostra em produÃ§Ã£o (opcional)
  if (env.runtime.isProd && !env.flags.debug) {
    badge.style.display = 'none'
  }

  return badge
}
```

### Passo 4: Atualizar main.js

```javascript
// src/main.js
import '@/style.css'
import { env } from '@/config/env.js'
import { createEnvironmentBadge } from '@components/EnvironmentBadge.js'
// ... outros imports

function renderApp() {
  // ... cÃ³digo existente

  // Adiciona badge de ambiente
  document.body.appendChild(createEnvironmentBadge())

  // Atualiza tÃ­tulo com nome do app
  document.title = `${env.app.name} - ${env.runtime.environment}`
}

renderApp()
```

### Passo 5: Scripts no package.json

```json
{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "build:staging": "vite build --mode staging",
    "preview": "vite preview",
    "preview:staging": "vite preview --mode staging"
  }
}
```

---

## âœ… Desafio da Aula

### Objetivo
Criar um sistema de feature flags baseado em variÃ¡veis de ambiente.

### InstruÃ§Ãµes

1. Crie uma variÃ¡vel `VITE_FEATURE_FLAGS` com JSON de features
2. Crie um mÃ³dulo que parseia e expÃµe as flags
3. Use as flags para mostrar/esconder um card "Beta Features"

### Exemplo de .env

```bash
VITE_FEATURE_FLAGS={"darkMode":true,"betaCard":true,"analytics":false}
```

### Spec de VerificaÃ§Ã£o

- [ ] O mÃ³dulo `featureFlags` exporta um objeto com as flags
- [ ] Quando `betaCard: true`, um card especial aparece no dashboard
- [ ] Quando `betaCard: false`, o card nÃ£o aparece

### SoluÃ§Ã£o

<details>
<summary>ğŸ” Clique para ver a soluÃ§Ã£o</summary>

```javascript
// src/config/features.js
const flagsJson = import.meta.env.VITE_FEATURE_FLAGS || '{}'

let flags = {}
try {
  flags = JSON.parse(flagsJson)
} catch (e) {
  console.error('Erro ao parsear feature flags:', e)
}

export const featureFlags = {
  darkMode: flags.darkMode ?? false,
  betaCard: flags.betaCard ?? false,
  analytics: flags.analytics ?? false
}

export function isEnabled(flag) {
  return featureFlags[flag] === true
}
```

```javascript
// src/components/BetaCard.js
import { isEnabled } from '@/config/features.js'

export function createBetaCard() {
  if (!isEnabled('betaCard')) {
    return null
  }

  const card = document.createElement('div')
  card.className = 'performance-card beta-card'
  card.innerHTML = `
    <span class="beta-badge">BETA</span>
    <h3 class="card-title">Funcionalidade Beta</h3>
    <p>Esta Ã© uma funcionalidade experimental!</p>
  `
  return card
}
```

```javascript
// src/main.js
import { createBetaCard } from '@components/BetaCard.js'

// Na funÃ§Ã£o de render
const betaCard = createBetaCard()
if (betaCard) {
  document.querySelector('.cards-grid').appendChild(betaCard)
}
```

</details>

---

**PrÃ³xima aula:** [1.7 â€” Build de ProduÃ§Ã£o e OtimizaÃ§Ã£o](./1.7-build-producao.md)
